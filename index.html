<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Mastery Hub - Giao diện mới</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234f46e5'%3E%3Cpath d='M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'%3E%3C/path%3E%3Ctext x='12' y='17' text-anchor='middle' font-family='sans-serif' font-size='9px' fill='white' font-weight='bold'%3EEM%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; /* Indigo-600 */
            --primary-hover: #4338ca; /* Indigo-700 */
            --primary-light: #e0e7ff; /* Indigo-100 */
            --secondary: #10b981; /* Emerald-500 */
            --text-primary: #1e293b; /* Slate-800 */
            --text-secondary: #475569; /* Slate-600 */
            --surface: #ffffff;
            --surface-alt: #f1f5f9; /* Slate-100 */
            --border: #e2e8f0; /* Slate-200 */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        html.dark {
            --text-primary: #f1f5f9; /* Slate-100 */
            --text-secondary: #94a3b8; /* Slate-400 */
            --surface: #1e293b; /* Slate-800 */
            --surface-alt: #334155; /* Slate-700 */
            --border: #475569; /* Slate-600 */
        }
        
        html.dark body {
            background-color: #0f172a; /* Slate-900 */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23334155' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            color: var(--text-primary);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e2e8f0' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            background-attachment: fixed;
            transition: background-color 0.3s, color 0.3s;
        }

        .main-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        
        .header h1 span {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .lookup-card {
            background-color: var(--surface);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .input-group:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .main-input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            background: transparent;
            color: var(--text-primary);
        }

        .icon-btn {
            background-color: transparent;
            border: none;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .icon-btn:hover {
            background-color: var(--surface-alt);
            color: var(--text-primary);
        }
        
        .primary-btn {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .primary-btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .tabs-container {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -ms-overflow-style: none; 
            scrollbar-width: none; 
        }
        .tabs-container::-webkit-scrollbar {
             display: none; 
        }

        .tab-btn {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tab-btn.active, .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { border-bottom-color: var(--primary); }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
        }

        .feature-btn {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
        }
        
        .feature-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .feature-btn .icon {
            width: 2.25rem;
            height: 2.25rem;
            display: grid;
            place-items: center;
            border-radius: 0.5rem;
            background-color: var(--primary-light);
            color: var(--primary);
            flex-shrink: 0;
        }
        
        .feature-btn .pro-badge {
            background: linear-gradient(135deg, #facc15, #f59e0b);
            color: #422006;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            margin-left: auto;
            text-transform: uppercase;
        }

        .external-links {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .external-links-title {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .external-links .links-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .external-btn {
            background-color: var(--surface-alt);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .external-btn:hover {
            color: var(--primary);
            border-color: var(--primary-light);
            background-color: var(--primary-light);
        }

        .message-alert {
            margin-top: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
            display: none;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .message-alert.show { display: block; animation: slideIn 0.3s ease-out; }
        .message-alert.error { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
        .message-alert.info { background: #dbeafe; color: #2563eb; border-color: #bfdbfe; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .content-section { background: var(--surface); border-radius: 20px; padding: 2.5rem; margin: 2rem 0; max-width: 1000px; box-shadow: var(--shadow-lg); display: none; position: relative; overflow: hidden; animation: fadeIn 0.5s ease-out; }
        .section-header{font-size:1.75rem;font-weight:700;color:var(--text-primary);margin-bottom:1.5rem;padding-bottom:.75rem;border-bottom:2px solid var(--border);display:flex;align-items:center;gap:.75rem}.loading-overlay{position:absolute;inset:0;background:hsla(0,0%,100%,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;border-radius:20px;transition:opacity .3s ease}.loading-spinner{width:48px;height:48px;border:4px solid var(--border);border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem}.loading-text{color:var(--primary);font-weight:600;font-size:1.125rem}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.exercise-item,.question-item{background:var(--surface-alt);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-bottom:1.5rem;transition:all .3s ease}.exercise-item:hover,.question-item:hover{transform:translateY(-2px);box-shadow:var(--shadow)}.exercise-sentence,.question-text{font-size:1.125rem;font-weight:500;color:var(--text-primary);margin-bottom:1rem;line-height:1.7}.exercise-options,.question-options{display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:1rem}.option-btn{background:var(--surface);color:var(--primary);border:2px solid var(--primary-light);padding:.75rem 1.25rem;border-radius:12px;cursor:pointer;font-weight:500;transition:all .3s ease;position:relative}
        html.dark .option-btn {
            color: #ffffff;
            border-color: var(--primary-light);
        }
        .option-btn:hover{transform:translateY(-2px);border-color:var(--primary);background-color:var(--primary-light);box-shadow:0 4px 12px rgba(79,70,229,.2)}.option-btn:disabled{cursor:not-allowed;opacity:.7}.option-btn:disabled:hover{transform:translateY(0);box-shadow:none;background-color:var(--surface)}.option-btn.correct{background:var(--secondary)!important;color:#fff!important;border-color:var(--secondary)!important}.option-btn.incorrect{background:#ef4444!important;color:#fff!important;border-color:#dc2626!important}.exercise-translation,.question-translation{font-style:italic;color:var(--text-secondary);font-size:.9rem}.exercise-feedback,.question-feedback{font-weight:600;margin-top:1rem;padding:.75rem 1rem;border-radius:8px;background:var(--surface-alt)}.table-container{overflow-x:auto;}table{width:100%;border-collapse:collapse;margin-top:1rem;border-radius:12px;overflow:hidden;box-shadow:var(--shadow);border:1px solid var(--border)}th,td{padding:1rem 1.25rem;text-align:left;border-bottom:1px solid var(--border);vertical-align:top}th{background:var(--surface-alt);font-weight:600;color:var(--text-primary)}tr:last-child td{border-bottom:none}tr:hover{background:rgba(79,70,229,.05)}.info-card{background:var(--surface-alt);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-bottom:1.5rem}.card-title{font-size:1.125rem;font-weight:600;color:var(--primary);margin-bottom:.75rem;display:flex;align-items:center;gap:.5rem}.card-title-alt{font-size:1.1rem;font-weight:600;margin-top:1rem;margin-bottom:.5rem;color:var(--text-primary)}.conversation-container{min-height:60vh;display:flex;flex-direction:column;background:var(--surface-alt);border-radius:16px;border:1px solid var(--border);overflow:hidden}.message-area{flex:1;overflow-y:auto;padding:1.5rem;display:flex;flex-direction:column;gap:1rem}.chat-message{max-width:75%;padding:.875rem 1.25rem;border-radius:18px;font-weight:500;line-height:1.5;animation:messageAppear .3s ease-out}.chat-message.ai{background:var(--surface);border:1px solid var(--border);color:var(--text-primary);align-self:flex-start;border-bottom-left-radius:6px}.chat-message.user{background:var(--primary);color:#fff;align-self:flex-end;border-bottom-right-radius:6px}@keyframes messageAppear{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.chat-input-container{padding:1rem 1.5rem;background:var(--surface);border-top:1px solid var(--border);display:flex;gap:1rem}.chat-input{flex:1;padding:.875rem 1.25rem;border:2px solid var(--border);border-radius:12px;outline:none;font-size:1rem;transition:all .3s ease;color:var(--text-primary);background-color:var(--surface-alt);}.chat-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}.chat-send-btn{background:var(--primary);color:#fff;border:none;padding:.875rem 1.5rem;border-radius:12px;cursor:pointer;font-weight:600;transition:all .3s ease}.chat-send-btn:hover{background:var(--primary-hover)}.audio-player{background:var(--surface-alt);border-radius:16px;padding:1.5rem;display:flex;flex-direction:column;align-items:center;gap:1rem;border:1px solid var(--border)}.audio-controls{display:flex;align-items:center;gap:1rem}.audio-btn{background:var(--primary);color:#fff;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s ease;box-shadow:var(--shadow)}.audio-btn:hover{background:var(--primary-hover);transform:scale(1.05)}.audio-btn:disabled{background-color:var(--text-secondary);cursor:not-allowed;transform:none;opacity:.7}.audio-btn .spinning-loader{width:24px;height:24px;border:3px solid hsla(0,0%,100%,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}.audio-status{font-weight:500;color:var(--text-secondary);min-width:100px;text-align:center}.transcript-toggle-btn{background-color:var(--surface);color:var(--primary);border:1px solid var(--primary-light);padding:.5rem 1rem;border-radius:12px;cursor:pointer;font-weight:500;transition:all .3s ease}.transcript-toggle-btn:hover{background-color:var(--primary-light)}.speaking-practice-card{min-height:100px;display:flex;align-items:center;justify-content:center}.textarea-input{width:100%;min-height:100px;padding:1rem;border-radius:12px;border:2px solid var(--border);font-size:1rem;resize:vertical;background-color:var(--surface);color:var(--text-primary)}.textarea-input:focus{outline:none;border-color:var(--primary)}
        
        .pronunciation-record-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow);
        }
        .pronunciation-record-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }
        .pronunciation-record-btn.recording {
            animation: pulse 1.5s infinite;
            background: #ef4444; /* Red color when recording */
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: var(--shadow); }
            50% { transform: scale(1.05); box-shadow: var(--shadow-lg); }
            100% { transform: scale(1); box-shadow: var(--shadow); }
        }
        .pronunciation-score-card {
            background: var(--surface);
            border: 2px solid var(--primary-light);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }
        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            background: var(--primary-light);
            border: 5px solid var(--primary);
        }


        .chat-message .translation { font-size: 0.8rem; margin-top: 0.5rem; font-style: italic; color: var(--text-secondary); opacity: 0.8; }
        .chat-message.user .translation { color: #e0e7ff; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--surface); margin: auto; padding: 2rem; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 700px; animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .close-button { color: var(--text-secondary); float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: var(--text-primary); text-decoration: none; cursor: pointer; }
        .correction-table th { background-color: var(--primary-light); color: var(--primary); }
        html.dark .correction-table th { background-color: #3e4c66; color: #a5b4fc; }
        .correction-table td strong { color: var(--primary); }
        
        .unused-words-section { background: var(--surface-alt); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-top: 1.5rem; }
        #unusedWordsList { color: var(--text-secondary) }
        
        @media (max-width: 768px) { .main-container { margin: 1.5rem auto; } .lookup-card, .content-section { padding: 1.5rem; } .header h1 { font-size: 2.25rem; } .tab-btn { padding: 0.75rem 1rem; } }
        @media (max-width: 640px) { 
            .main-container { margin: 1rem auto; padding: 0 0.75rem; } 
            .header { margin-bottom: 1.5rem; } 
            .header h1 { font-size: 1.875rem; } 
            .header p { font-size: 1rem; } 
            .lookup-card, .content-section { padding: 1rem; border-radius: 1rem; } 
            .input-group { flex-wrap: wrap; gap: 0.75rem; } 
            .main-input { flex-basis: 100%; order: 1; text-align: center; } 
            .primary-btn { flex-basis: 100%; order: 3; justify-content: center; } 
            .icon-btn { padding: 0.5rem; } 
            .input-group > .icon-btn:first-of-type { order: 2; margin-left: auto; } 
            .input-group > .icon-btn:nth-of-type(2) { order: 2; margin-right: auto; } 
            .features-grid { grid-template-columns: 1fr; } 
            .content-section { padding: 1.5rem 1rem; } 
            .section-header { font-size: 1.5rem; } 
            
            .practice-actions {
                gap: 0.5rem;
                flex-wrap: wrap; 
                justify-content: center;
            }
            .practice-actions .feature-btn,
            .practice-actions .primary-btn,
            .pronunciation-record-btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.875rem; 
                flex-grow: 0; 
                justify-content: center;
            }
        }
    </style>
</head>
<body class="transition-colors duration-300">

    <div class="main-container">
        <header class="header relative">
            <div class="absolute top-0 right-0">
                <button id="theme-toggle" class="icon-btn p-2 rounded-full" title="Chuyển chế độ Sáng/Tối">
                    <svg id="theme-toggle-dark-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <h1>Chào mừng đến với <span>English Mastery Hub</span></h1>
            <p>Công cụ học tiếng Anh toàn diện, được hỗ trợ bởi AI</p>
        </header>

        <div class="lookup-card">
            <div class="input-group">
                <input type="text" class="main-input" id="vocabularyInput" placeholder="Nhập từ, câu, chủ đề để học...">
                <button class="icon-btn" id="btnPasteClipboard" title="Dán từ clipboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1-1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                </button>
                <button class="icon-btn" id="btnClearInput" title="Xóa nội dung">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                </button>
                <button class="primary-btn" id="btnQuickSearch">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><path d="M8 11.5v-3"></path><path d="M14 11.5v-3"></path></svg>
                    Tra & Nghe
                </button>
            </div>
            <div class="message-alert" id="messageBox"></div>
            <div id="quickSearchResults" class="mt-4"></div>

            <div class="tabs-container">
                <button class="tab-btn active" data-tab="tab-learn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    Học & Luyện Tập
                </button>
                <button class="tab-btn" data-tab="tab-create">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    Sáng Tạo & Viết
                </button>
                 <button class="tab-btn" data-tab="tab-analyze">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                    Phân Tích & Khám Phá
                </button>
                <button class="tab-btn" data-tab="tab-interactive">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 18a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2"></path><rect x="3" y="4" width="18" height="18" rx="2"></rect><circle cx="12" cy="10" r="2"></circle><line x1="8" y1="2" x2="8" y2="4"></line><line x1="16" y1="2" x2="16" y2="4"></line></svg>
                    Tương Tác AI
                </button>
            </div>

            <div id="tab-learn" class="tab-content active">
                <div class="features-grid">
                    <button class="feature-btn" id="btnGenerateExplanation"><span class="icon">📚</span><span>Giải thích Từ vựng / Ngữ pháp <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnGenerateExamples"><span class="icon">💡</span><span>Tạo Ví dụ theo Ngữ cảnh</span></button>
                    <button class="feature-btn" id="btnGenerateExercise"><span class="icon">✍️</span><span>Bài tập Điền từ & Trắc nghiệm <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnGenerateListeningFillInTheBlank"><span class="icon">🎧</span><span>Bài tập Nghe & Điền từ <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnGenerateReadingAndQuestions"><span class="icon">📖</span><span>Bài đọc & Câu hỏi <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnGenerateListeningAndQuestions"><span class="icon">🗣️</span><span>Bài nghe & Câu hỏi <span class="pro-badge">PRO</span></span></button>
                </div>
            </div>

            <div id="tab-create" class="tab-content">
                <div class="features-grid">
                    <button class="feature-btn" id="btnCorrectSentence"><span class="icon">📝</span><span>Sửa lỗi Chính tả & Ngữ pháp <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnGenerateDialogue"><span class="icon">💬</span><span>Tạo Đoạn Hội thoại</span></button>
                    <button class="feature-btn" id="btnGenerateParagraphs"><span class="icon">📄</span><span>Viết Đoạn văn theo Từ khóa</span></button>
                    <button class="feature-btn" id="btnSummarizeText"><span class="icon">📋</span><span>Tóm tắt Văn bản</span></button>
                    <button class="feature-btn" id="btnDraftEmail"><span class="icon">📧</span><span>Soạn thảo Email chuyên nghiệp <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnGenerateImage"><span class="icon">🖼️</span><span>Tạo ảnh minh họa từ vựng <span class="pro-badge">PRO</span></span></button>
                </div>
            </div>

            <div id="tab-analyze" class="tab-content">
                <div class="features-grid">
                    <button class="feature-btn" id="btnCompareVocabulary"><span class="icon">⚖️</span><span>So sánh các Từ vựng tương tự</span></button>
                    <button class="feature-btn" id="btnAnalyzeTone"><span class="icon">🎭</span><span>Phân tích Giọng điệu (Tone)</span></button>
                    <button class="feature-btn" id="btnExplainIdiom"><span class="icon">🌟</span><span>Giải thích Thành ngữ (Idioms)</span></button>
                    <button class="feature-btn" id="btnCheckPopularity"><span class="icon">📊</span><span>Kiểm tra Mức độ Phổ Biến</span></button>
                    <button class="feature-btn" id="btnTranslateSentence"><span class="icon">🔁</span><span>Dịch câu Việt - Anh</span></button>
                </div>
            </div>

            <div id="tab-interactive" class="tab-content">
                <div class="features-grid">
                    <button class="feature-btn" id="btnStartConversationSimulator"><span class="icon">🤖</span><span>Mô phỏng Hội
                            thoại với AI <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnStartSpeakingPractice"><span class="icon">🎙️</span><span>Luyện phản xạ nói
                            (AI) <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnStartWritingPractice"><span class="icon">✍️</span><span>Luyện viết có Sửa lỗi
                            (AI) <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnStartSpeakingPracticeManual"><span class="icon">🗣️</span><span>Luyện phản xạ
                            (Thủ công)</span></button>
                    <button class="feature-btn" id="btnStartWritingPracticeManual"><span class="icon">✍️</span><span>Luyện viết (Thủ
                            công)</span></button>
                </div>
            </div>

            <div class="external-links">
                <h3 class="external-links-title">Công cụ tra cứu bên ngoài</h3>
                <div class="links-group">
                    <button class="external-btn" id="btnGoogleTranslate">Google Dịch</button>
                    <button class="external-btn" id="btnOxfordDictionary">Từ điển Oxford</button>
                    <button class="external-btn" id="btnYouglish">YouGlish (Phát âm)</button>
                    <button class="external-btn" id="btnGoogleImages">Google Hình ảnh</button>
                </div>
            </div>

        </div>
    </div>
    
    <div id="content-results-area" class="main-container">
    </div>

    <!-- Modal for Grammar Correction -->
    <div id="correctionModal" class="modal">
        <div class="modal-content">
            <span id="closeCorrectionModal" class="close-button">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Kiểm tra & Sửa lỗi</h2>
            <div id="modalCorrectionContent">
            </div>
        </div>
    </div>

    <!-- Modal for Manual Speaking Practice Input -->
    <div id="manualSpeakingModal" class="modal">
        <div class="modal-content">
            <span id="closeManualSpeakingModal" class="close-button">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Luyện phản xạ (Thủ công)</h2>
            <div class="info-card mb-4">
                <p class="mb-2 font-semibold">Nhập các câu tiếng Việt bạn muốn luyện tập, mỗi câu một dòng:</p>
                <textarea id="manualSentencesInput" class="textarea-input" rows="8" placeholder="Ví dụ:&#10;Hôm nay trời đẹp quá.&#10;Tôi đang học tiếng Anh.&#10;Bạn có khỏe không?"></textarea>
                <div class="mt-3 flex items-center">
                    <input type="checkbox" id="randomOrderCheckbox" class="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="randomOrderCheckbox" class="text-gray-700 dark:text-gray-300">Xuất hiện các câu ngẫu nhiên trong danh sách?</label>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button id="startManualPracticeBtn" class="primary-btn">Bắt đầu Luyện tập</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for Professional Email Prompt -->
    <div id="emailPromptModal" class="modal">
        <div class="modal-content">
            <span id="closeEmailPromptModal" class="close-button">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Soạn thảo Email chuyên nghiệp</h2>
            <div class="info-card mb-4">
                <p class="mb-2 font-semibold">Nhập đề bài, chủ đề hoặc yêu cầu viết thư của bạn vào đây:</p>
                <textarea id="emailPromptInput" class="textarea-input" rows="10" placeholder="Ví dụ: Dán đề bài thi viết thư VSTEP của bạn vào đây..."></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button id="startEmailGenerationBtn" class="primary-btn">Tạo Email</button>
            </div>
        </div>
    </div>

    <div id="writingPracticeManualModal" class="modal">
        <div class="modal-content">
            <span id="closeWritingPracticeManualModal" class="close-button">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Luyện dịch (Thủ công)</h2>
            <div class="info-card mb-4">
                <p class="mb-2 font-semibold">Nhập các cặp từ/câu, mỗi cặp một dòng. Dùng dấu <code class="bg-gray-200 dark:bg-gray-600 px-1 rounded-md">=</code> để ngăn cách:</p>
                <textarea id="manualWritingInput" class="textarea-input" rows="8" placeholder="Ví dụ:&#10;sữa = milk&#10;Hôm nay trời đẹp. = Today is a beautiful day.&#10;Bạn có khỏe không? = How are you?"></textarea>
                
                <div class="mt-4">
                    <p class="font-semibold mb-2">Chế độ luyện tập:</p>
                    <div class="flex flex-wrap gap-x-6 gap-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="modeViToEn" name="practiceMode" value="vi-en" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <label for="modeViToEn" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Dịch từ Anh sang Việt</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modeEnToVi" name="practiceMode" value="en-vi" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <label for="modeEnToVi" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Dịch từ Việt sang Anh</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="modeRandom" name="practiceMode" value="random" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <label for="modeRandom" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Ngẫu nhiên 2 chiều</label>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex items-center">
                    <input type="checkbox" id="randomWritingCheckbox" class="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="randomWritingCheckbox" class="text-gray-700 dark:text-gray-300">Xuất hiện ngẫu nhiên trong danh sách?</label>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button id="startManualWritingBtn" class="primary-btn">Bắt đầu Luyện tập</button>
            </div>
        </div>
    </div>


    <script>
        // --- Theme Toggle Logic ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        const applyTheme = () => {
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        };

        themeToggleBtn.addEventListener('click', function() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            applyTheme();
        });

        // --- Tabbed Interface Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(); 

            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
            attachEventListeners();
        });


        // --- Global State ---
        let conversationHistory = [];
        let unusedWords = [];
        let currentUtteranceQueue = []; 
        let isSpeakingFullDialogue = false;
        let recognition; // Global variable for SpeechRecognition instance
        let isRecording = false; // To track recording state
        var currentGlobalKeyListener = null; // BIẾN MỚI
        
        // --- DOM Element References ---
        const vocabularyInput = document.getElementById('vocabularyInput');
        const messageBox = document.getElementById('messageBox');
        const contentResultsArea = document.getElementById('content-results-area');
        const quickSearchResults = document.getElementById('quickSearchResults');
        const correctionModal = document.getElementById('correctionModal');
        const closeCorrectionModalBtn = document.getElementById('closeCorrectionModal');
        const modalCorrectionContent = document.getElementById('modalCorrectionContent');
        const contentContainers = {};

        // --- UI Helper Functions ---
        function hideAllSections() {
            if (speechSynthesis.speaking || speechSynthesis.pending) {
                speechSynthesis.cancel();
            }
            if (recognition && recognition.abort) {
                recognition.abort();
            }
            currentUtteranceQueue = [];
            isSpeakingFullDialogue = false;

            // Dọn dẹp trình lắng nghe sự kiện Enter toàn cục
            if (currentGlobalKeyListener) {
                document.removeEventListener('keydown', currentGlobalKeyListener);
                currentGlobalKeyListener = null;
            }

            // Stop recording if active when hiding sections
            if (isRecording) {
                if (recognition) recognition.stop();
                isRecording = false;
                const recordBtn = document.getElementById('record-pronunciation-btn');
                if (recordBtn) {
                    recordBtn.classList.remove('recording');
                    recordBtn.querySelector('span').textContent = 'Ghi âm & Chấm điểm';
                }
            }

            contentResultsArea.innerHTML = '';
            quickSearchResults.innerHTML = '';
            Object.keys(contentContainers).forEach(key => delete contentContainers[key]);
        }

        function createContentSection(featureKey, headerText) {
            hideAllSections();
            const containerId = `${featureKey}Container`;
            const overlayId = `${featureKey}LoadingOverlay`;
            const contentId = `${featureKey}Content`;

            const sectionHTML = `
                <div class="content-section" id="${containerId}" style="display: block;">
                    <div class="loading-overlay" id="${overlayId}">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">${headerText}...</div>
                    </div>
                    <div id="${contentId}"></div>
                </div>
            `;
            contentResultsArea.innerHTML = sectionHTML;
            
            contentContainers[featureKey] = {
                container: document.getElementById(containerId),
                overlay: document.getElementById(overlayId),
                content: document.getElementById(contentId)
            };
            
            document.getElementById(containerId).scrollIntoView({ behavior: 'smooth', block: 'start' });

            return contentContainers[featureKey];
        }

        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `message-alert show ${type}`;
        }

        function hideMessage() {
            messageBox.className = 'message-alert';
        }

        function clearInput() {
            vocabularyInput.value = '';
            hideMessage();
            vocabularyInput.focus();
            hideAllSections();
        }

        async function pasteFromClipboard() {
            hideMessage();
            if (!navigator.clipboard?.readText) {
                showMessage('Trình duyệt của bạn không hỗ trợ dán tự động. Vui lòng dùng tổ hợp phím Ctrl+V.', 'error');
                return;
            }
            try {
                const text = await navigator.clipboard.readText();
                vocabularyInput.value = text;
                showMessage('Đã dán thành công!', 'info');
            } catch (err) {
                console.error('Lỗi khi dán:', err);
                showMessage('Dán tự động bị chặn bởi trình duyệt. Vui lòng dùng Ctrl+V hoặc Cmd+V để dán.', 'error');
            }
        }
        
        // --- Main Feature Functions ---
        function openLink(type) {
            const vocabulary = vocabularyInput.value.trim();
            if (!vocabulary) {
                showMessage('Vui lòng nhập từ vựng để tìm kiếm.', 'error');
                return;
            }
            const urls = {
                googleTranslate: `https://translate.google.com/?sl=en&tl=vi&text=${encodeURIComponent(vocabulary)}&op=translate`,
                oxfordDictionary: `https://www.oxfordlearnersdictionaries.com/definition/english/${encodeURIComponent(vocabulary)}`,
                youglish: `https://youglish.com/pronounce/${encodeURIComponent(vocabulary)}/english/us`,
                googleImages: `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(vocabulary)}`
            };
            if (urls[type]) {
                window.open(urls[type], '_blank');
            }
        }

        async function callGemini(prompt, schema = null, isTextOnly = false) {
             let chatHistory = [];
             chatHistory.push({ role: "user", parts: [{ text: prompt }] });
             const payload = { contents: chatHistory };
             if (schema && !isTextOnly) {
                 payload.generationConfig = {
                     responseMimeType: "application/json",
                     responseSchema: schema
                 };
             }
             const apiKey = "AIzaSyByNgUKCZKSKYMLUV7AhkxRKcWG2mBxAyI"; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
             
             const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });
             
             if (!response.ok) {
                const errorBody = await response.text();
                console.error("API Error Response:", errorBody);
                throw new Error(`Lỗi API: ${response.status} ${response.statusText}`);
             }

             const result = await response.json();
             
             if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                 const text = result.candidates[0].content.parts[0].text;
                 if (isTextOnly) {
                    return text;
                 }
                 try {
                     return JSON.parse(text);
                 } catch (e) {
                     console.error("Lỗi phân tích JSON:", e, "Dữ liệu gốc:", text);
                     throw new Error("Không thể phân tích phản hồi từ API.");
                 }
             }
             console.error("Phản hồi API không hợp lệ:", result);
             throw new Error('Cấu trúc phản hồi API không mong đợi hoặc trống.');
        }

        async function handleFeature(featureKey, headerText, promptGenerator, renderer, inputValidator = (input) => !!input, featureInputValue) {
            const { container, content, overlay } = createContentSection(featureKey, `Đang ${headerText.toLowerCase()}`);

            let featureInput = featureInputValue !== undefined ? featureInputValue : vocabularyInput.value.trim();

            if (!inputValidator(featureInput)) {
                showMessage(`Vui lòng nhập đầu vào hợp lệ cho chức năng này.`, 'error');
                hideAllSections();
                return;
            }

            try {
                if (['conversationSimulator', 'speakingPractice', 'speakingPracticeManual', 'writingPractice', 'writingPracticeManual'].includes(featureKey)) {
                     await renderer(featureInput, content, headerText);
                } else {
                    const { prompt, schema } = promptGenerator(featureInput);
                    const data = await callGemini(prompt, schema);
                    renderer(data, content, headerText);
                }
            } catch (error) {
                showMessage(`Có lỗi xảy ra khi tạo nội dung. Vui lòng thử lại.`, 'error');
                console.error(`Lỗi với chức năng ${featureKey}:`, error);
                content.innerHTML = `<p class="text-red-500 font-semibold">Đã xảy ra lỗi: ${error.message}</p>`;
            } finally {
                if (overlay) overlay.style.display = 'none';
            }
        }

        // --- RENDERERS ---
        const renderers = {
             spellCheckSuggestion: (originalWord, correctedWord, el) => {
                el.innerHTML = `
                    <div class="info-card p-4 text-center border-yellow-400 bg-yellow-50 dark:bg-yellow-900/50 dark:border-yellow-600">
                        <p class="text-yellow-800 dark:text-yellow-200">
                            Ý bạn là: <strong class="text-yellow-900 dark:text-yellow-100 font-bold cursor-pointer hover:underline" onclick="searchWithCorrection('${correctedWord.replace(/'/g, "\\'")}')">${correctedWord}</strong>?
                        </p>
                        <div class="mt-3">
                             <button class="external-btn" onclick="quickSearch({ bypassSpellCheck: true, wordToSearch: '${originalWord.replace(/'/g, "\\'")}' })">
                                Vẫn tra cứu '${originalWord}'
                             </button>
                        </div>
                    </div>
                `;
            },
            quickLookup: (data, el) => {
                el.innerHTML = `
                    <div class="info-card p-4">
                      <div class="flex items-center gap-4">
                         <button class="audio-btn" style="width: 44px; height: 44px; min-width: 44px;" onclick="speakText(vocabularyInput.value)" title="Nghe lại">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.026 8a6.48 6.48 0 0 0-1.905-4.596l-1.414 1.414A4.486 4.486 0 0 1 10.026 8c0 1.353-.6 2.544-1.515 3.328l1.414 1.414zM8.707 11.182A4.5 4.5 0 0 0 10.026 8a4.5 4.5 0 0 0-1.319-3.182L8.707 5.18a2.5 2.5 0 0 1 0 5.64l.001.002zM6.343 4.828a.5.5 0 0 0 0 .707L7.05 6.243a.5.5 0 0 0 .707 0l.707-.707a.5.5 0 0 0 0-.707L7.757 4.12a.5.5 0 0 0-.707 0l-.708.707zM4.717 6.464a.5.5 0 0 0 0 .708L5.424 7.88a.5.5 0 0 0 .707 0l.707-.707a.5.5 0 0 0 0-.708L6.128 5.757a.5.5 0 0 0-.707 0l-.708.707zM2 8a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1A.5.5 0 0 1 2 8z"/></svg>
                         </button>
                         <div>
                            <p class="text-xl font-semibold text-indigo-600 dark:text-indigo-400">${data.ipa}</p>
                            <p class="mt-1 text-lg">${data.meaning}</p>
                         </div>
                      </div>
                    </div>
                `;
            },
            examples: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">💡 ${headerText}</h2>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>STT</th><th>Cấu trúc</th><th>Tiếng Anh</th><th>Phát âm</th><th>Tiếng Việt</th></tr></thead>
                            <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td class="text-center">${item.STT}</td>
                                    <td>${item['Cấu trúc câu']}</td>
                                    <td>${item['Ví dụ (tiếng Anh)']}</td>
                                    <td class="text-center">
                                        <button class="icon-btn" onclick="speakText('${item['Ví dụ (tiếng Anh)'].replace(/'/g, "\\'")}')" title="Nghe">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.026 8a6.48 6.48 0 0 0-1.905-4.596l-1.414 1.414A4.486 4.486 0 0 1 10.026 8c0 1.353-.6 2.544-1.515 3.328l1.414 1.414zM8.707 11.182A4.5 4.5 0 0 0 10.026 8a4.5 4.5 0 0 0-1.319-3.182L8.707 5.18a2.5 2.5 0 0 1 0 5.64l.001.002zM6.343 4.828a.5.5 0 0 0 0 .707L7.05 6.243a.5.5 0 0 0 .707 0l.707-.707a.5.5 0 0 0 0-.707L7.757 4.12a.5.5 0 0 0-.707 0l-.708.707zM4.717 6.464a.5.5 0 0 0 0 .708L5.424 7.88a.5.5 0 0 0 .707 0l.707-.707a.5.5 0 0 0 0-.708L6.128 5.757a.5.5 0 0 0-.707 0l-.708.707zM2 8a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1A.5.5 0 0 1 2 8z"/></svg>
                                        </button>
                                    </td>
                                    <td>${item['Ví dụ (Tiếng Việt)']}</td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            exercise: (data, el, headerText) => {
                el.innerHTML = `<h2 class="section-header">✨ ${headerText}</h2>` + data.map(item => `
                    <div class="exercise-item">
                        <p class="exercise-sentence">${item.id}. ${item.sentence_with_blank}</p>
                        <div class="exercise-options">${item.options.map(option => `<button class="option-btn" data-value="${option.replace(/"/g, '&quot;')}" onclick="checkFillInBlankAnswer(this, '${item.correct_word.replace(/'/g, "\\'")}')">${option}</button>`).join('')}</div>
                        <p class="exercise-translation">(Dịch: ${item.translation})</p>
                        <div class="exercise-feedback"></div>
                    </div>`).join('');
            },
            listeningFillInTheBlank: (data, el, headerText) => {
                 el.innerHTML = `<h2 class="section-header">🎧 ${headerText}</h2>` + data.map(item => `
                    <div class="exercise-item">
                        <div class="flex items-center gap-4 mb-4">
                             <button class="audio-btn" onclick="playQuestionAudio(this, '${item.audio_sentence.replace(/'/g, "\\'")}')" title="Nghe câu">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M10.804 8 5 4.633v6.734L10.804 8zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg>
                             </button>
                             <p class="exercise-sentence flex-1">${item.id}. ${item.sentence_with_blank}</p>
                        </div>
                        <div class="exercise-options">${item.options.map(option => `<button class="option-btn" data-value="${option.replace(/"/g, '&quot;')}" onclick="checkFillInBlankAnswer(this, '${item.correct_word.replace(/'/g, "\\'")}')">${option}</button>`).join('')}</div>
                        <p class="exercise-translation">(Dịch: ${item.translation})</p>
                        <div class="exercise-feedback"></div>
                    </div>`).join('');
            },
            explanation: (data, el, headerText) => {
                const renderStars = (popularity) => {
                    let stars = '';
                    for (let i = 1; i <= 5; i++) {
                        stars += i <= popularity ? '★' : '☆';
                    }
                    return `<span class="text-yellow-400">${stars}</span>`;
                };

                const renderTermList = (items) => {
                    if (!items || items.length === 0) return '<li>Không có</li>';
                    return items.map(item => `
                        <li class="flex justify-between items-center py-1">
                            <div>
                                <span class="font-medium">${item.term}</span> 
                                <span class="text-gray-500 dark:text-gray-400">(${item.translation})</span>
                            </div>
                            ${renderStars(item.popularity)}
                        </li>
                    `).join('');
                };

                const meaningsTableHTML = `
                    <div class="info-card">
                        <h3 class="card-title">📖 Bảng nghĩa</h3>
                        <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nghĩa</th>
                                    <th>Cụm từ đi chung (Ví dụ)</th>
                                    <th>Mức độ phổ biến</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.meanings_table.map(item => `
                                    <tr>
                                        <td>${item.meaning}</td>
                                        <td><em>${item.example_collocation}</em></td>
                                        <td>${renderStars(item.frequency)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                    </div>
                `;

                const mainDefinitionHTML = `
                    <div class="info-card">
                        <h3 class="card-title">📘 Định nghĩa chi tiết</h3>
                        <p>${data.main_definition}</p>
                    </div>
                `;
                
                el.innerHTML = `
                    <h2 class="section-header">📚 ${headerText}: ${data.word}</h2>
                    ${meaningsTableHTML}
                    ${mainDefinitionHTML}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="info-card">
                            <h3 class="card-title">👍 Từ đồng nghĩa</h3>
                            <ul class="list-none space-y-2">${renderTermList(data.synonyms)}</ul>
                        </div>
                        <div class="info-card">
                            <h3 class="card-title">👎 Từ trái nghĩa</h3>
                            <ul class="list-none space-y-2">${renderTermList(data.antonyms)}</ul>
                        </div>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title">🤝 Cách dùng phổ biến (Collocations)</h3>
                         <ul class="list-none space-y-2">${renderTermList(data.collocations)}</ul>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title">⚠️ Lưu ý cách dùng</h3>
                        <p>${data.usage_notes}</p>
                    </div>
                `;
            },
            correction: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">✍️ ${headerText}</h2>
                    <div class="info-card">
                        <p><strong>Câu gốc:</strong> <span class="text-red-500 line-through">${data.original_sentence}</span></p>
                        <p class="mt-2"><strong>Câu đã sửa:</strong> <span class="text-green-600 font-semibold">${data.corrected_sentence}</span></p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title">🔄 Các thay đổi:</h3>
                        <ul class="list-disc list-inside">${data.changes.map(change => `<li>${change}</li>`).join('')}</ul>
                    </div>
                     <div class="info-card">
                        <h3 class="card-title">🇻🇳 Dịch nghĩa:</h3>
                        <p>${data.translation}</p>
                    </div>`;
            },
            dialogue: (data, el, headerText) => {
                const characterAlignments = new Map();
                let nextAlignment = 'left';

                const getAlignment = (character) => {
                    if (!characterAlignments.has(character)) {
                        characterAlignments.set(character, nextAlignment);
                        nextAlignment = (nextAlignment === 'left') ? 'right' : 'left';
                    }
                    return characterAlignments.get(character);
                };

                const allEnglishLines = data.map(line => line.english_line);

                el.innerHTML = `
                    <h2 class="section-header flex justify-between items-center">
                        <span>💬 ${headerText}</span>
                        <button id="playFullDialogueBtn" class="primary-btn text-sm px-3 py-1.5" title="Phát âm toàn bộ đoạn hội thoại">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M10.804 8 5 4.633v6.734L10.804 8zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg>
                             Phát âm toàn bộ
                        </button>
                    </h2>
                    <div class="flex flex-col gap-4 p-4 rounded-lg bg-slate-50 dark:bg-slate-900/50">
                    ${data.map((line) => {
                        const alignment = getAlignment(line.character);
                        const isLeft = alignment === 'left';
                        
                        const alignmentClasses = isLeft 
                            ? 'bg-white dark:bg-slate-700 rounded-bl-none' 
                            : 'bg-indigo-50 dark:bg-indigo-950 rounded-br-none';
                        
                        const mainTextColor = 'text-slate-800 dark:text-slate-200';
                        const translationTextColor = 'text-slate-500 dark:text-slate-400';

                        const characterColor = isLeft
                            ? 'text-emerald-600 dark:text-emerald-400'
                            : 'text-indigo-600 dark:text-indigo-400';

                        return `
                        <div class="w-full flex ${isLeft ? 'justify-start' : 'justify-end'}">
                            <div class="p-3 rounded-xl max-w-xl ${alignmentClasses} shadow-sm border border-black/5 dark:border-white/5">
                                <div class="flex items-start gap-3">
                                     <div class="flex-grow">
                                        <strong class="${characterColor} font-bold block">${line.character}</strong>
                                        <p class="${mainTextColor} mt-1">${line.english_line}</p>
                                    </div>
                                    <button class="icon-btn flex-shrink-0 -mt-1 -mr-1" onclick="speakText('${line.english_line.replace(/'/g, "\\'")}')" title="Nghe câu này">
                                       <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"> <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/> <path d="M10.121 12.596A6.48 6.48 0 0 0 12.026 8a6.48 6.48 0 0 0-1.905-4.596l-1.414 1.414A4.486 4.486 0 0 1 10.026 8c0 1.353-.6 2.544-1.515 3.328l1.414 1.414zM8.707 11.182A4.5 4.5 0 0 0 10.026 8a4.5 4.5 0 0 0-1.319-3.182L8.707 5.18a2.5 2.5 0 0 1 0 5.64l.001.002zM6.343 4.828a.5.5 0 0 0 0 .707L7.05 6.243a.5.5 0 0 0 .707 0l.707-.707a.5.5 0 0 0 0-.707L7.757 4.12a.5.5 0 0 0-.707 0l-.708.707zM4.717 6.464a.5.5 0 0 0 0 .708L5.424 7.88a.5.5 0 0 0 .707 0l.707-.707a.5.5 0 0 0 0-.708L6.128 5.757a.5.5 0 0 0-.707 0l-.708.707zM2 8a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1A.5.5 0 0 1 2 8z"/> </svg>
                                    </button>
                                </div>
                                <p class="text-sm ${translationTextColor} italic mt-2">(Dịch: ${line.vietnamese_line})</p>
                            </div>
                        </div>`;
                    }).join('')}
                    </div>`;

                document.getElementById('playFullDialogueBtn').addEventListener('click', () => {
                    playFullDialogue(allEnglishLines);
                });
            },
            summary: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">📋 ${headerText}</h2>
                    <div class="info-card"><p class="leading-relaxed">${data.summary.replace(/\n/g, '<br>')}</p></div>`;
            },
            paragraphs: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">📄 ${headerText}</h2>
                    <div class="info-card">
                        <h3 class="card-title-alt">📝 English Paragraph:</h3>
                        <p>${data.english_paragraph}</p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title-alt">📖 Bản dịch tiếng Việt:</h3>
                        <p>${data.vietnamese_translation}</p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title-alt">📖 Bản dịch hỗn hợp (Anh-Việt):</h3>
                        <p>${data.mixed_vietnamese_translation}</p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title-alt">🗣️ Từ vựng đã sử dụng:</h3>
                        <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Từ vựng</th>
                                    <th>Nghĩa</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.vocabulary_list.map((item, index) => `<tr><td>${index + 1}</td><td>${item.word}</td><td>${item.meaning}</td></tr>`).join('')}
                            </tbody>
                        </table>
                        </div>
                    </div>`;
            },
            popularity: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">📊 ${headerText}</h2>
                     <div class="table-container">
                    <table>
                        <thead><tr><th>Từ/Cụm từ</th><th>Mức độ</th><th>Bản dịch</th><th>Ngữ cảnh</th></tr></thead>
                        <tbody>
                            <tr>
                                <td class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${data.original_item}</td>
                                <td><span class="font-medium px-2 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200">${data.popularity_status}</span></td>
                                <td>${data.translation}</td>
                                <td>${data.context_explanation}</td>
                            </tr>
                            ${(data.suggested_alternatives && data.suggested_alternatives.length > 0) ? data.suggested_alternatives.map(alt => `
                                <tr>
                                    <td class="font-semibold">${alt.alternative_item}</td>
                                    <td><span class="font-medium px-2 py-1 rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-200">${alt.popularity_status}</span></td>
                                    <td>${alt.translation}</td>
                                    <td>${alt.context_explanation}</td>
                                </tr>`).join('') : ''
                            }
                        </tbody>
                    </table>
                    </div>`;
            },
            reading: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">📖 ${headerText}</h2>
                    <div class="info-card">
                        <h3 class="card-title">📝 Bài đọc</h3>
                        <div class="prose max-w-none dark:text-gray-300">${data.reading_passage.replace(/\n/g, '<br>')}</div>
                    </div>
                    <h3 class="card-title mt-6">❓ Câu hỏi</h3>` + 
                    data.questions.map(q => `
                    <div class="question-item" data-correct-answer="${q.correct_option.replace(/"/g, '&quot;')}" data-question-translation="${q.question_translation.replace(/"/g, '&quot;')}">
                        <p class="question-text">${q.id}. ${q.question_text}</p>
                        <div class="question-options">${q.options.map(opt => `<button class="option-btn" onclick="checkMultipleChoiceAnswer(this)">${opt}</button>`).join('')}</div>
                        <div class="question-feedback"></div>
                    </div>`).join('');
            },
            listening: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">🎧 ${headerText}</h2>
                    <div class="info-card mb-4">
                        <div id="audioPlayerContainer"></div>
                        <div class="flex justify-center mt-4">
                           <button id="toggleTranscriptBtn" class="transcript-toggle-btn">📜 Hiện văn bản</button>
                        </div>
                    </div>
                    <div id="transcriptContent" class="info-card hidden">
                        <h3 class="card-title">📝 Văn bản bài nghe</h3>
                        <div class="prose max-w-none dark:text-gray-300 p-2">${data.audio_script.replace(/\n/g, '<br>')}</div>
                        <h3 class="card-title-alt mt-4">📖 Bản dịch</h3>
                        <div class="prose max-w-none dark:text-gray-400 p-2">${data.audio_script_translation.replace(/\n/g, '<br>')}</div >
                    </div>
                    <h3 class="card-title-alt mt-6">❓ Câu hỏi</h3>` + 
                    data.questions.map(q => `
                    <div class="question-item" data-correct-answer="${q.correct_option.replace(/"/g, '&quot;')}" data-question-translation="${q.question_text_translation.replace(/"/g, '&quot;')}" >
                        <p class="question-text">${q.id}. ${q.question_text}</p>
                        <div class="question-options">${q.options.map(opt => `<button class="option-btn" onclick="checkMultipleChoiceAnswer(this)">${opt}</button>`).join('')}</div>
                        <div class="question-feedback"></div>
                    </div>`).join('');
                
                setupAudioPlayer(data.audio_script, document.getElementById('audioPlayerContainer'));

                const toggleBtn = document.getElementById('toggleTranscriptBtn');
                const transcriptContent = document.getElementById('transcriptContent');
                toggleBtn.addEventListener('click', () => {
                    const isHidden = transcriptContent.classList.toggle('hidden');
                    toggleBtn.innerHTML = isHidden ? '📜 Hiện văn bản' : '📜 Ẩn văn bản';
                });
            },
            conversationSimulator: async (scenario, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">🗣️ ${headerText}: ${scenario}</h2>
                    <div class="conversation-container">
                        <div class="message-area" id="messageArea"></div>
                        <div class="chat-input-container">
                            <input type="text" id="chatInput" class="chat-input" placeholder="Nhập câu trả lời của bạn...">
                            <button id="chatSendButton" class="chat-send-btn">Gửi</button>
                        </div>
                    </div>
                    <div id="unusedWordsSection" class="unused-words-section">
                        <h3 class="card-title">Gợi ý từ vựng:</h3>
                        <p id="unusedWordsList"></p>
                    </div>`;
                
                const chatInput = document.getElementById('chatInput');
                const chatSendButton = document.getElementById('chatSendButton');

                const handleSend = () => continueConversation(scenario);
                chatSendButton.addEventListener('click', handleSend);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend();
                    }
                });

                await initializeUnusedWords(scenario);

                const systemPrompt = `You are a helpful AI assistant named Alex, designed for English learners. Your task is to role-play a scenario. The current scenario is: '${scenario}'. Start the conversation naturally. Keep your responses friendly, encouraging, and not too long. Provide your English response and its Vietnamese translation in JSON format: {"english": "Your English response", "vietnamese": "Bản dịch tiếng Việt của bạn"}.`;
                conversationHistory = [{ role: 'user', parts: [{ text: systemPrompt }] }];

                await getNextAiResponse();
            },
            idiom: (data, el, headerText) => {
                 el.innerHTML = `
                    <h2 class="section-header">🌟 ${headerText}: ${data.idiom}</h2>
                    <div class="info-card">
                        <p><strong>Nghĩa đen:</strong> ${data.literal_translation || "Không có"}</p>
                        <p class="mt-2"><strong>Nghĩa bóng (Ý nghĩa thật):</strong> ${data.meaning}</p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title">🌍 Nguồn gốc & cách dùng</h3>
                        <p>${data.origin}</p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title">💡 Ví dụ</h3>
                        <ul class="list-disc list-inside space-y-3">${data.examples.map(ex => `<li><strong>EN:</strong> "${ex.english}"<br><span class="text-gray-500 dark:text-gray-400"><strong>VN:</strong> "${ex.vietnamese}"</span></li>`).join('')}</ul>
                    </div>`;
            },
            comparison: (data, el, headerText) => {
                 el.innerHTML = `
                    <h2 class="section-header">⚖️ ${headerText}</h2>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Từ</th><th>Giải thích</th><th>Ví dụ</th><th>Nghĩa ví dụ</th></tr></thead>
                            <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${item.word}</td>
                                    <td>${item.explanation}</td>
                                    <td><em>"${item.example_sentence}"</em></td>
                                    <td><em>${item.example_translation}</em></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            // NEW RENDERER FOR VSTEP EMAILS
            vstepEmails: (data, el, headerText) => {
                el.innerHTML = `<h2 class="section-header">📧 ${headerText}</h2>` +
                data.emails.map(email => `
                    <div class="info-card">
                        <h3 class="card-title">
                            <span class="font-medium px-3 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200">
                                Cấp độ ${email.level}
                            </span>
                        </h3>
                        <pre class="whitespace-pre-wrap font-sans leading-relaxed p-2 bg-white dark:bg-slate-800 rounded-lg">${email.body}</pre>
                    </div>
                `).join('');
            },
            imageGenerator: (imageUrl, el, headerText, prompt) => {
                el.innerHTML = `
                    <h2 class="section-header">🖼️ ${headerText}</h2>
                    <div class="info-card text-center">
                        <p class="mb-4 text-lg font-semibold">Ảnh được tạo từ: "${prompt}"</p>
                        <img src="${imageUrl}" alt="AI Generated Image for ${prompt}" class="mx-auto rounded-lg shadow-md max-w-full h-auto" />
                    </div>
                `;
            },
            tone: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">🎭 ${headerText}</h2>
                    <div class="info-card">
                        <h3 class="card-title">Câu gốc</h3>
                        <p class="italic">"${data.original_sentence}"</p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title">Giọng điệu được phát hiện</h3>
                        <p><span class="font-medium px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-200">${data.tone}</span></p>
                        <p class="mt-2">${data.explanation}</p>
                    </div>
                     ${(data.suggestions && data.suggestions.length > 0) ? `
                     <div class="info-card">
                        <h3 class="card-title"> Gợi ý điều chỉnh</h3>
                        <ul class="list-disc list-inside space-y-2">
                            ${data.suggestions.map(s => `<li><strong>${s.new_tone}:</strong> ${s.rewritten_sentence}</li></li>`).join('')}
                        </ul>
                     </div>` : ''}
                `;
            },
            translationResults: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">🔁 ${headerText}</h2>
                     <div class="table-container">
                    <table>
                        <thead><tr><th>Bản dịch Tiếng Anh</th><th>Mức độ phổ biến</th><th>Ghi chú sử dụng</th></tr></thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td class="font-semibold">${item.english_translation}</td>
                                    <td><span class="font-medium px-2 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200">${item.popularity_status}</span></td>
                                    <td>${item.usage_note}</td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                    </div>`;
            },
            speakingPractice: async (topic, el, headerText) => {
                 const { prompt, schema } = prompts.speakingPractice(topic);
                 const data = await callGemini(prompt, schema);
                 // Pass the array of sentences to renderSpeakingPracticeUI, even if it's just one for AI mode initially
                 renderSpeakingPracticeUI(el, [data.vietnamese_sentence], topic, 'ai');
            },
            speakingPracticeManual: (input, el, headerText) => {
                // 'input' here is the array of sentences from the modal for manual mode
                renderSpeakingPracticeUI(el, input, '', 'manual'); // Pass the sentences array
            },
            writingPractice: async (topic, el, headerText) => {
                 const { prompt, schema } = prompts.writingPractice(topic);
                 const data = await callGemini(prompt, schema);
                 renderWritingPracticeUI(el, data, topic);
            },
            writingPracticeManual: (data, el) => {
                // data now contains { pairs, direction }
                renderWritingPracticeUIManual(el, data.pairs, data.direction);
            },
        };
        
        // New helper function to highlight differences
        function highlightDifferences(target, spoken) {
            const targetWords = target.toLowerCase().split(/\s+/).filter(w => w);
            const spokenWords = spoken.toLowerCase().split(/\s+/).filter(w => w);

            let highlightedSpoken = [];
            // Use a simple comparison for highlighting. More advanced diffing algorithms could be used.
            for (let i = 0; i < Math.max(targetWords.length, spokenWords.length); i++) {
                const targetWord = targetWords[i];
                const spokenWord = spokenWords[i];

                if (spokenWord === undefined) {
                    // If spoken text is shorter than target, remaining target words are implicitly "missing"
                    // We don't highlight missing words in the spoken text, only what was said incorrectly.
                    break;
                } else if (targetWord === undefined) {
                    // If spoken text is longer than target, extra words in spoken text are incorrect
                    highlightedSpoken.push(`<span class="text-red-500 font-bold">${spokenWord}</span>`);
                } else if (targetWord === spokenWord) {
                    highlightedSpoken.push(spokenWord);
                } else {
                    highlightedSpoken.push(`<span class="text-red-500 font-bold">${spokenWord}</span>`);
                }
            }
            return highlightedSpoken.join(' ');
        }


        function renderSpeakingPracticeUI(el, initialSentences, topic, mode) {
            let sentences = initialSentences; // This will be an array of sentences
            let currentIndex = 0;
            let currentSuggestions = [];
            let currentVietnameseSentence = sentences[currentIndex]; // Initialize with the first sentence

            el.innerHTML = `
                <h2 class="section-header">🎙️ Luyện phản xạ nói ${mode === 'manual' ? '(Thủ công)' : '(AI)'}</h2>
                <div id="speaking-practice-card" class="info-card text-center relative speaking-practice-card">
                    <p class="text-2xl font-semibold" id="vietnamese-sentence-display"></p>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" id="speaking-practice-loader" style="display:none;">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <div class="flex justify-center items-center gap-4 mt-4 practice-actions">
                    <button id="show-answer-btn" class="primary-btn">💡 Hiện gợi ý</button>
                    <button id="record-pronunciation-btn" class="pronunciation-record-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/></svg>
                        <span>Ghi âm & Chấm điểm</span>
                    </button>
                    <button id="new-sentence-btn" class="feature-btn">🔄 Câu khác</button>
                </div>
                <div id="answer-container" class="mt-6 hidden"></div>
                <div id="pronunciation-score-container" class="mt-6 hidden"></div>
                `;

            const sentenceDisplay = document.getElementById('vietnamese-sentence-display');
            const answerContainer = document.getElementById('answer-container');
            const newSentenceBtn = document.getElementById('new-sentence-btn');
            const showAnswerBtn = document.getElementById('show-answer-btn');
            const recordBtn = document.getElementById('record-pronunciation-btn');
            const scoreContainer = document.getElementById('pronunciation-score-container');
            const loader = document.getElementById('speaking-practice-loader');

            const fetchAndSetSuggestions = async (vietnameseSentence) => {
                try {
                    showAnswerBtn.disabled = true;
                    showAnswerBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;
                    const { prompt, schema } = prompts.speakingPracticeSingle(vietnameseSentence);
                    const suggestionData = await callGemini(prompt, schema);
                    currentSuggestions = suggestionData.suggestions;

                    let answerHTML = `<div class="table-container"><h3 class="card-title">Gợi ý trả lời</h3><table><thead><tr><th>Gợi ý (Tiếng Anh)</th><th>Mức độ phổ biến</th></tr></thead><tbody>`;
                    currentSuggestions.forEach(s => {
                        answerHTML += `<tr><td>${s.translation}</td><td><span class="font-medium px-2 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200">${s.popularity}</span></td></tr>`;
                    });
                    answerHTML += `</tbody></table></div>`;
                    answerContainer.innerHTML = answerHTML;
                    answerContainer.classList.remove('hidden');
                    showAnswerBtn.textContent = '🙈 Ẩn gợi ý';
                } catch (e) {
                    answerContainer.innerHTML = `<p class="text-red-500">Không thể tải gợi ý.</p>`;
                    showAnswerBtn.textContent = '💡 Hiện gợi ý';
                } finally {
                    showAnswerBtn.disabled = false;
                }
            };
            
            const displaySentence = (sentence) => {
                currentVietnameseSentence = sentence; // Update global current Vietnamese sentence
                sentenceDisplay.textContent = sentence;
                answerContainer.innerHTML = '';
                answerContainer.classList.add('hidden');
                scoreContainer.innerHTML = '';
                scoreContainer.classList.add('hidden');
                showAnswerBtn.textContent = '💡 Hiện gợi ý';
                showAnswerBtn.disabled = false;
                currentSuggestions = []; 
            };
            
            const showNextSentence = async () => {
                newSentenceBtn.disabled = true;
                loader.style.display = 'block';
                sentenceDisplay.style.opacity = '0.3';
                
                if (mode === 'ai') {
                    const { prompt, schema } = prompts.speakingPractice(topic);
                    const data = await callGemini(prompt, schema);
                    displaySentence(data.vietnamese_sentence);
                } else { 
                    // Manual mode: Cycle through the provided sentences
                    currentIndex = (currentIndex + 1) % sentences.length;
                    displaySentence(sentences[currentIndex]);
                }
                
                loader.style.display = 'none';
                sentenceDisplay.style.opacity = '1';
                newSentenceBtn.disabled = false;
            };
            
            showAnswerBtn.addEventListener('click', () => {
                if (answerContainer.classList.contains('hidden')) {
                    fetchAndSetSuggestions(currentVietnameseSentence); // Use the global currentVietnameseSentence
                } else {
                    answerContainer.classList.add('hidden');
                    showAnswerBtn.textContent = '💡 Hiện gợi ý';
                }
            });

            recordBtn.addEventListener('click', () => {
                if (isRecording) {
                    // If recording, stop it
                    if (recognition) recognition.stop();
                } else {
                    // If not recording, start it
                    handlePronunciationRecording(currentVietnameseSentence, currentSuggestions);
                }
            });

            newSentenceBtn.addEventListener('click', showNextSentence);
            
            displaySentence(currentVietnameseSentence); // Initial display
        }
        
        function renderWritingPracticeUI(el, initialData, topic) {
            el.innerHTML = `
                <h2 class="section-header">✍️ Luyện viết (AI)</h2>
                <div class="info-card">
                    <h3 class="card-title">Dịch câu sau sang tiếng Anh:</h3>
                    <p id="vietnamese-writing-prompt" class="text-xl font-semibold text-center py-4"></p>
                </div>
                <textarea id="english-writing-input" class="textarea-input" placeholder="Viết câu trả lời của bạn ở đây..."></textarea>
                <div id="writing-feedback-container" class="mt-4"></div>
                <div class="flex justify-center gap-4 mt-4 practice-actions">
                     <button id="check-writing-btn" class="primary-btn">✔️ Kiểm tra</button>
                     <button id="hint-writing-btn" class="feature-btn">💡 Gợi ý</button>
                     <button id="next-writing-btn" class="feature-btn">🔄 Câu khác</button>
                </div>
            `;
            
            const promptDisplay = document.getElementById('vietnamese-writing-prompt');
            const inputArea = document.getElementById('english-writing-input');
            const feedbackContainer = document.getElementById('writing-feedback-container');
            const checkBtn = document.getElementById('check-writing-btn');
            const hintBtn = document.getElementById('hint-writing-btn');
            const nextBtn = document.getElementById('next-writing-btn');

            const fetchNewSentence = async () => {
                feedbackContainer.innerHTML = '';
                inputArea.value = '';
                promptDisplay.textContent = 'Đang tải câu mới...';
                const { prompt, schema } = prompts.writingPractice(topic);
                const data = await callGemini(prompt, schema);
                promptDisplay.textContent = data.vietnamese_sentence;
                checkBtn.disabled = false;
                hintBtn.disabled = false;
            };

            hintBtn.addEventListener('click', async () => {
                 const currentSentence = promptDisplay.textContent;
                 feedbackContainer.innerHTML = 'Đang tải gợi ý...';
                 const { prompt, schema } = prompts.speakingPracticeSingle(currentSentence);
                 const data = await callGemini(prompt, schema);
                 let answerHTML = `<div class="info-card table-container"><h3 class="card-title">Gợi ý trả lời</h3><table><thead><tr><th>Gợi ý (Tiếng Anh)</th><th>Mức độ phổ biến</th></tr></thead><tbody>`;
                 data.suggestions.forEach(s => {
                     answerHTML += `<tr><td>${s.translation}</td><td><span class="font-medium px-2 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200">${s.popularity}</span></td></tr>`;
                 });
                 answerHTML += `</tbody></table></div>`;
                 feedbackContainer.innerHTML = answerHTML;
            });
            
            checkBtn.addEventListener('click', async () => {
                const vietnameseSentence = promptDisplay.textContent;
                const userEnglish = inputArea.value.trim();
                
                if (!userEnglish) {
                    showMessage("Vui lòng nhập câu trả lời của bạn.", 'error');
                    return;
                }
                
                checkBtn.disabled = true;
                hintBtn.disabled = true;
                feedbackContainer.innerHTML = 'Đang kiểm tra...';
                
                const { prompt, schema } = prompts.checkTranslation(vietnameseSentence, userEnglish);
                const result = await callGemini(prompt, schema);
                
                let resultHTML;
                if(result.is_correct) {
                    resultHTML = `
                        <div class="info-card border-green-500 bg-green-50 dark:bg-green-900/50 dark:border-green-700">
                            <h3 class="card-title text-green-700 dark:text-green-300">🎉 Chính xác!</h3>
                            <p>Câu trả lời của bạn rất tốt.</p>
                            <div class="flex justify-center mt-4"><button onclick="this.closest('#writing-feedback-container').innerHTML='';document.getElementById('next-writing-btn').click()" class="feature-btn">Tiếp tục</button></div>
                        </div>
                    `;
                } else {
                     resultHTML = `
                         <div class="info-card border-red-500 bg-red-50 dark:bg-red-900/50 dark:border-red-700">
                            <h3 class="card-title text-red-700 dark:text-red-300">⚠️ Cần xem lại!</h3>
                            <p><strong>Câu của bạn:</strong> <span class="line-through">${result.original_sentence}</span></p>
                            <p class="mt-2"><strong>Câu đã sửa:</strong> <span class="font-semibold text-green-600 dark:text-green-400">${result.corrected_sentence}</span></p>
                            <h4 class="card-title-alt mt-4">Các thay đổi:</h4>
                            <ul class="list-disc list-inside">${result.changes.map(change => `<li>${change}</li>`).join('')}</ul>
                            <div class="flex justify-center mt-4"><button onclick="this.closest('#writing-feedback-container').innerHTML='';document.getElementById('next-writing-btn').click()" class="feature-btn">Tiếp tục</button></div>
                        </div>`;
                }
                feedbackContainer.innerHTML = resultHTML;
            });

            nextBtn.addEventListener('click', fetchNewSentence);
            
            promptDisplay.textContent = initialData.vietnamese_sentence;
        }

        function renderWritingPracticeUIManual(el, pairs, initialDirection) {
            let currentIndex = 0;
            let currentDirection = initialDirection;
            let isAnswerChecked = false; // Biến trạng thái để theo dõi

            el.innerHTML = `
                <h2 class="section-header">✍️ Luyện dịch (Thủ công)</h2>
                <div class="info-card">
                    <h3 id="prompt-title" class="card-title"></h3>
                    <p id="translation-prompt" class="text-2xl font-semibold text-center py-4"></p>
                </div>
                <textarea id="translation-input" class="textarea-input" placeholder="Nhập bản dịch của bạn ở đây..."></textarea>
                <div id="translation-feedback" class="mt-4"></div>
                <div class="flex justify-center gap-4 mt-4 practice-actions">
                     <button id="check-translation-btn" class="primary-btn">✔️ Kiểm tra</button>
                     <button id="show-answer-btn" class="feature-btn">💡 Xem đáp án</button>
                     <button id="next-item-btn" class="feature-btn">🔄 Câu khác</button>
                </div>
            `;
            
            const promptTitle = document.getElementById('prompt-title');
            const promptDisplay = document.getElementById('translation-prompt');
            const inputArea = document.getElementById('translation-input');
            const feedbackContainer = document.getElementById('translation-feedback');
            const checkBtn = document.getElementById('check-translation-btn');
            const showAnswerBtn = document.getElementById('show-answer-btn');
            const nextBtn = document.getElementById('next-item-btn');

            // --- Các hàm xử lý logic cốt lõi ---
            const displayItem = () => {
                feedbackContainer.innerHTML = '';
                inputArea.value = '';
                inputArea.disabled = false;
                checkBtn.disabled = false;
                showAnswerBtn.disabled = false;
                isAnswerChecked = false; // Reset trạng thái khi có câu hỏi mới

                const currentPair = pairs[currentIndex];
                let promptText, answerText;

                if (initialDirection === 'random') {
                    currentDirection = Math.random() < 0.5 ? 'vi-en' : 'en-vi';
                }

                if (currentDirection === 'vi-en') {
                    promptTitle.textContent = 'Dịch câu sau sang Tiếng Anh:';
                    promptText = currentPair.vi;
                    answerText = currentPair.en;
                } else {
                    promptTitle.textContent = 'Dịch câu sau sang Tiếng Việt:';
                    promptText = currentPair.en;
                    answerText = currentPair.vi;
                }
                
                promptDisplay.textContent = promptText;
                inputArea.dataset.answer = answerText;
                inputArea.focus();
            };

            const checkAnswer = () => {
                const userAnswer = inputArea.value.trim();
                if (!userAnswer && !isAnswerChecked) return;

                const correctAnswer = inputArea.dataset.answer;
                let feedbackHTML;
                if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    feedbackHTML = `<div class="info-card border-green-500 bg-green-50 dark:bg-green-900/50"><h3 class="card-title text-green-700 dark:text-green-300">🎉 Chính xác!</h3></div>`;
                } else {
                    feedbackHTML = `<div class="info-card border-red-500 bg-red-50 dark:bg-red-900/50"><h3 class="card-title text-red-700 dark:text-red-300">⚠️ Chưa đúng!</h3><p><strong>Câu trả lời của bạn:</strong> ${userAnswer}</p><p class="mt-2"><strong>Đáp án đúng là:</strong> <span class="font-semibold text-green-600">${correctAnswer}</span></p></div>`;
                }
                
                feedbackContainer.innerHTML = feedbackHTML;
                inputArea.disabled = true;
                checkBtn.disabled = true;
                showAnswerBtn.disabled = true;
                isAnswerChecked = true;
            };
            
            const showAnswer = () => {
                const correctAnswer = inputArea.dataset.answer;
                feedbackContainer.innerHTML = `<div class="info-card border-blue-500 bg-blue-50 dark:bg-blue-900/50"><h3 class="card-title text-blue-700 dark:text-blue-300">Đáp án đúng</h3><p class="font-semibold text-lg">${correctAnswer}</p></div>`;
                inputArea.disabled = true;
                checkBtn.disabled = true;
                showAnswerBtn.disabled = true;
                isAnswerChecked = true;
            };

            const showNextItem = () => {
                currentIndex = (currentIndex + 1) % pairs.length;
                displayItem();
            };

            // --- Logic xử lý Enter mới ---
            
            // Xóa trình lắng nghe cũ (nếu có) trước khi thêm cái mới
            if (currentGlobalKeyListener) {
                document.removeEventListener('keydown', currentGlobalKeyListener);
            }

            const handleGlobalEnterPress = (e) => {
                if (el.offsetParent === null) return; // Chỉ hoạt động khi component đang hiển thị

                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (isAnswerChecked) {
                        showNextItem();
                    } else {
                        checkAnswer();
                    }
                }
            };
            
            // Lưu và gắn trình lắng nghe vào document
            currentGlobalKeyListener = handleGlobalEnterPress;
            document.addEventListener('keydown', currentGlobalKeyListener);

            checkBtn.addEventListener('click', checkAnswer);
            showAnswerBtn.addEventListener('click', showAnswer);
            nextBtn.addEventListener('click', showNextItem);
            
            displayItem();
        }

        // --- PROMPTS ---
        const prompts = {
            spellCheck: (input) => ({
                prompt: `Check if the English word or phrase "${input}" is spelled correctly. If it's incorrect, provide the most likely correct spelling. The word should be considered correct if it's a proper noun or common slang. Return a JSON object with keys "is_correct" (boolean) and "corrected_word" (string, which is the suggestion if incorrect, or the original word if correct).`,
                schema: { type: "OBJECT", properties: { is_correct: { type: "BOOLEAN" }, corrected_word: { type: "STRING" } }, required: ["is_correct", "corrected_word"] }
            }),
            quickLookup: (input) => ({
                prompt: `For the English word or phrase "${input}", provide its simple Vietnamese meaning and its IPA transcription. Return a JSON object with keys "meaning" and "ipa".`,
                schema: { type: "OBJECT", properties: { ipa: { type: "STRING" }, meaning: { type: "STRING" } }, required: ["ipa", "meaning"] }
            }),
            pronunciationScore: (targetSentence, spokenText) => ({
                prompt: `Compare the spoken text "${spokenText}" against the target English sentence "${targetSentence}". Provide a similarity score from 0 to 100 representing pronunciation accuracy, and a brief feedback comment in Vietnamese. Return JSON with keys "score" (number) and "feedback" (string).`,
                schema: { type: "OBJECT", properties: { score: { type: "NUMBER" }, feedback: { type: "STRING" } }, required: ["score", "feedback"] }
            }),
            examples: (input) => ({ prompt: `Tạo 10-15 câu ví dụ tiếng Anh và bản dịch tiếng Việt cho từ hoặc cụm từ "${input}" với các cấu trúc câu đa dạng. Trả về dưới dạng mảng JSON với các thuộc tính: "STT", "Cấu trúc câu", "Ví dụ (tiếng Anh)", "Ví dụ (Tiếng Việt)".`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { "STT": { "type": "NUMBER" }, "Cấu trúc câu": { "type": "STRING" }, "Ví dụ (tiếng Anh)": { "type": "STRING" }, "Ví dụ (Tiếng Việt)": { "type": "STRING" } }, required: ["STT", "Cấu trúc câu", "Ví dụ (tiếng Anh)", "Ví dụ (Tiếng Việt)"] } } }),
            exercise: (input) => ({ prompt: `Tạo 10 câu bài tập điền vào chỗ trống cho từ/chủ đề tiếng Anh "${input}". Mỗi câu, cung cấp câu với "____", từ đúng, 4 lựa chọn ngẫu nhiên (bao gồm đáp án đúng, các đáp án được xáo trộn ngầu nhiên tránh tình trạng toàn A B C hoặc D không được lặp lại 10 câu chỉ 1 loại đáp án A ), và bản dịch tiếng Việt. Trả về mảng JSON với các thuộc tính: "id", "sentence_with_blank", "correct_word", "options", "translation".`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, sentence_with_blank: { type: "STRING" }, correct_word: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, translation: { type: "STRING" } }, required: ["id", "sentence_with_blank", "correct_word", "options", "translation"] } } }),
            listeningFillInTheBlank: (input) => ({ prompt: `Tạo 10 câu bài tập nghe và điền vào chỗ trống cho từ/chủ đề tiếng Anh "${input}". Mỗi câu phải có: câu tiếng Anh đầy đủ để phát âm, câu đó với một từ được thay bằng "____", từ đúng, 4 lựa chọn ngẫu nhiên (bao gồm đáp án đúng, các đáp án được xáo trộn ngầu nhiên tránh tình trạng toàn A B C hoặc D), và bản dịch tiếng Việt của câu đầy đủ. Trả về mảng JSON với các thuộc tính: "id", "audio_sentence", "sentence_with_blank", "correct_word", "options", "translation".`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, audio_sentence: { type: "STRING" }, sentence_with_blank: { type: "STRING" }, correct_word: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, translation: { type: "STRING" } }, required: ["id", "audio_sentence", "sentence_with_blank", "correct_word", "options", "translation"] } } }),
            explanation: (input) => ({ prompt: `Cung cấp giải thích từ vựng chuyên sâu cho từ tiếng Anh "${input}". Trả về một đối tượng JSON với các thuộc tính sau: 'word' (từ gốc), 'meanings_table' (một mảng các đối tượng, mỗi đối tượng có 'meaning' - định nghĩa ngắn gọn bằng tiếng Việt, 'frequency' - mức độ phổ biến từ 1 đến 5, và 'example_collocation' - một cụm từ ví dụ), 'main_definition' (định nghĩa chính, chi tiết bằng tiếng Việt), 'synonyms' (mảng các đối tượng có 'term' - từ đồng nghĩa tiếng Anh, 'translation' - bản dịch tiếng Việt, 'popularity' - mức độ phổ biến từ 1-5), 'antonyms' (tương tự synonyms), 'collocations' (tương tự synonyms), 'usage_notes' (lưu ý sử dụng bằng tiếng Việt).`, schema: { type: "OBJECT", properties: { word: { "type": "STRING" }, meanings_table: { type: "ARRAY", items: { type: "OBJECT", properties: { meaning: { "type": "STRING" }, frequency: { "type": "NUMBER" }, example_collocation: { "type": "STRING" } }, required: ["meaning", "frequency", "example_collocation"] } }, main_definition: { "type": "STRING" }, synonyms: { type: "ARRAY", items: { type: "OBJECT", properties: { term: { "type": "STRING" }, translation: { "type": "STRING" }, popularity: { "type": "NUMBER" } }, required: ["term", "translation", "popularity"] } }, antonyms: { type: "ARRAY", items: { type: "OBJECT", properties: { term: { "type": "STRING" }, translation: { "type": "STRING" }, popularity: { "type": "NUMBER" } }, required: ["term", "translation", "popularity"] } }, collocations: { type: "ARRAY", items: { type: "OBJECT", properties: { term: { "type": "STRING" }, translation: { "type": "STRING" }, popularity: { "type": "NUMBER" } }, required: ["term", "translation", "popularity"] } }, usage_notes: { "type": "STRING" } }, required: ["word", "meanings_table", "main_definition", "synonyms", "antonyms", "collocations", "usage_notes"] } }),
            correction: (input) => ({ prompt: `Sửa lỗi câu tiếng Anh sau: "${input}". Cung cấp câu gốc, phiên bản đã sửa, danh sách các thay đổi (giải thích ngắn gọn từng lỗi BẰNG TIẾNG VIỆT), và bản dịch tiếng Việt của câu đã sửa. Trả về đối tượng JSON với các khóa: "original_sentence", "corrected_sentence", "changes" (mảng các chuỗi TIẾNG VIỆT), "translation".`, schema: { type: "OBJECT", properties: { original_sentence: { type: "STRING" }, corrected_sentence: { type: "STRING" }, changes: { type: "ARRAY", items: { type: "STRING" } }, translation: { type: "STRING" } }, required: ["original_sentence", "corrected_sentence", "changes", "translation"] } }),
            dialogue: (input) => ({ prompt: `Tạo một đoạn hội thoại tiếng Anh tự nhiên (khoảng 15-20 dòng) về chủ đề "${input}" với ít nhất hai nhân vật. Cung cấp tên nhân vật, lời thoại tiếng Anh và bản dịch tiếng Việt cho mỗi dòng. Trả về mảng JSON các đối tượng có khóa: "character", "english_line", "vietnamese_line".`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { character: { type: "STRING" }, english_line: { type: "STRING" }, vietnamese_line: { type: "STRING" } }, required: ["character", "english_line", "vietnamese_line"] } } }),
            summary: (input) => ({ prompt: `Tóm tắt văn bản tiếng Anh sau đây thành tiếng Việt một cách ngắn gọn, tập trung vào các ý chính: "${input}". Trả về một đối tượng JSON với một khóa duy nhất "summary".`, schema: { type: "OBJECT", properties: { summary: { type: "STRING" } }, required: ["summary"] } }),
            paragraphs: (input) => ({ prompt: `Sử dụng các từ vựng sau đây: "${input}", hãy thực hiện các yêu cầu sau: 1. Viết một đoạn văn tiếng Anh tự nhiên, logic, trình độ A1-B1 , sử dụng TẤT CẢ các từ vựng đã cho. Trong đoạn văn, hãy bôi đậm (dùng thẻ <b>) mỗi từ vựng khi nó xuất hiện. 2. Dịch toàn bộ đoạn văn tiếng Anh đó sang tiếng Việt. 3. Tạo một phiên bản dịch "hỗn hợp": lấy bản dịch tiếng Việt ở bước 2, nhưng thay thế các từ đã dịch bằng TỪ VỰNG GỐC TIẾNG ANH được tô đậm. 4. Liệt kê lại danh sách các từ vựng đã dùng, mỗi từ kèm theo nghĩa tiếng Việt của nó. Trả về một đối tượng JSON với các khóa: "english_paragraph" (string), "vietnamese_translation" (string), "mixed_vietnamese_translation" (string), và "vocabulary_list" (mảng các đối tượng, mỗi đối tượng có 'word' và 'meaning').`, schema: { type: "OBJECT", properties: { english_paragraph: { type: "STRING" }, vietnamese_translation: { type: "STRING" }, mixed_vietnamese_translation: { type: "STRING" }, vocabulary_list: { type: "ARRAY", items: { type: "OBJECT", properties: { word: { type: "STRING" }, meaning: { type: "STRING" } }, required: ["word", "meaning"] } } }, required: ["english_paragraph", "vietnamese_translation", "mixed_vietnamese_translation", "vocabulary_list"] } }),
            popularity: (input) => ({ prompt: `Phân tích mức độ phổ biến của từ/cụm từ tiếng Anh "${input}". Cung cấp trạng thái của nó ("Rất phổ biến", "Phổ biến", "Ít phổ biến", "Không tự nhiên"), bản dịch, và giải thích ngữ cảnh sử dụng. Nếu không phổ biến, đề xuất 2-3 phương án thay thế tốt hơn. Trả về đối tượng JSON có khóa: "original_item", "popularity_status", "translation", "context_explanation", "suggested_alternatives" (mảng các đối tượng có các khóa tương tự).`, schema: { type: "OBJECT", properties: { original_item: { type: "STRING" }, popularity_status: { type: "STRING" }, translation: { type: "STRING" }, context_explanation: { type: "STRING" }, suggested_alternatives: { type: "ARRAY", items: { type: "OBJECT", properties: { alternative_item: { type: "STRING" }, popularity_status: { type: "STRING" }, translation: { type: "STRING" }, context_explanation: { type: "STRING" } } } } }, required: ["original_item", "popularity_status", "translation", "context_explanation"] } }),
            reading: (input) => ({ prompt: `Tạo một bài đọc hiểu tiếng Anh (khoảng 150-200 từ, trình độ A2-B1) về chủ đề "${input}". Sau đó, tạo 5 câu hỏi trắc nghiệm. Mỗi câu hỏi có 4 lựa chọn và chỉ một đáp án đúng. Trả về JSON với các thuộc tính: "reading_passage" (string), "questions" (mảng 5 đối tượng), mỗi đối tượng chứa: "id" (số), "question_text" (string), "question_translation" (string), "options" (mảng 4 string), và "correct_option" (string của đáp án đúng).`, schema: { type: "OBJECT", properties: { reading_passage: { type: "STRING" }, questions: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, question_text: { type: "STRING" }, question_translation: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correct_option: { type: "STRING" } }, required: ["id", "question_text", "question_translation", "options", "correct_option"] } } }, required: ["reading_passage", "questions"] } }),
            listening: (input) => ({ prompt: `Tạo một kịch bản nghe tiếng Anh (khoảng 100-150 từ, trình độ A2-B1, tốc độ nói tự nhiên) về chủ đề "${input}". Sau đó, dịch kịch bản đó sang tiếng Việt. Tiếp theo, tạo 5 câu hỏi trắc nghiệm dựa trên nội dung bài nghe. Mỗi câu hỏi có 4 lựa chọn và chỉ một đáp án đúng. Trả về JSON với các thuộc tính: "audio_script" (string), "audio_script_translation" (string), "questions" (mảng 5 đối tượng), mỗi đối tượng chứa: "id" (số), "question_text" (string), "question_text_translation" (string), "options" (mảng 4 string), và "correct_option" (string của đáp án đúng).`, schema: { type: "OBJECT", properties: { audio_script: { type: "STRING" }, audio_script_translation: { type: "STRING" }, questions: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, question_text: { type: "STRING" }, question_text_translation: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correct_option: { type: "STRING" } }, required: ["id", "question_text", "question_text_translation", "options", "correct_option"] } } }, required: ["audio_script", "audio_script_translation", "questions"] } }),
            speakingPractice: (input) => ({ prompt: `Dựa vào chủ đề "${input}", hãy tạo một câu tiếng Việt đơn giản ngẫu nhiên là câu hỏi, phủ định, khẳng định hoặc câu ghép chia đều % xuất hiện các câu, phù hợp cho người học tiếng Anh trình độ A2-B1. Trả về một đối tượng JSON với khóa duy nhất "vietnamese_sentence".`, schema: { type: "OBJECT", properties: { vietnamese_sentence: { type: "STRING" } }, required: ["vietnamese_sentence"] } }),
            speakingPracticeSingle: (vietnameseSentence) => ({ prompt: `Hãy cung cấp 3 bản dịch tiếng Anh cho câu tiếng Việt sau: "${vietnameseSentence}". Mỗi bản dịch kèm theo mức độ phổ biến ("Rất phổ biến", "Phổ biến", "Ít phổ biến"). Trả về một đối tượng JSON với khóa "suggestions" (một mảng các đối tượng, mỗi đối tượng có khóa "translation" và "popularity").`, schema: { type: "OBJECT", properties: { suggestions: { type: "ARRAY", items: { type: "OBJECT", properties: { translation: { type: "STRING" }, popularity: { type: "STRING"}}, required: ["translation", "popularity"] } } }, required: ["suggestions"] } }),
            writingPractice: (input) => ({ prompt: `Dựa vào chủ đề "${input}", hãy tạo một câu tiếng Việt đơn giản, ngẫu nhiên, phù hợp cho người học tiếng Anh trình độ A2-B1. Trả về một đối tượng JSON với khóa duy nhất "vietnamese_sentence".`, schema: { type: "OBJECT", properties: { vietnamese_sentence: { type: "STRING" } }, required: ["vietnamese_sentence"] } }),
            checkTranslation: (vietnameseSentence, englishSentence) => ({ prompt: `Dựa trên câu gốc tiếng Việt: "${vietnameseSentence}", hãy kiểm tra và sửa lỗi câu dịch tiếng Anh sau: "${englishSentence}". Cung cấp câu gốc, phiên bản đã sửa, danh sách các thay đổi (giải thích ngắn gọn từng lỗi BẰNG TIẾNG VIỆT). Nếu câu dịch đã đúng, hãy cho biết nó đúng. Trả về đối tượng JSON với các khóa: "is_correct" (boolean), "original_sentence", "corrected_sentence", "changes" (mảng chuỗi).`, schema: { type: "OBJECT", properties: { is_correct: {type: "BOOLEAN"}, original_sentence: { type: "STRING" }, corrected_sentence: { type: "STRING" }, changes: { type: "ARRAY", items: { type: "STRING" } } }, required: ["is_correct", "original_sentence", "corrected_sentence", "changes"] } }),
            comparison: (input) => ({ prompt: `So sánh các từ/cụm từ tiếng Anh sau: "${input}". Đối với mỗi từ, giải thích sắc thái ý nghĩa và cách dùng bằng tiếng Việt, kèm theo một câu ví dụ minh họa và bản dịch tiếng Việt của câu ví dụ đó. Trả về một mảng JSON, mỗi đối tượng có các khóa: "word", "explanation", "example_sentence", "example_translation".`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { word: { type: "STRING" }, explanation: { type: "STRING" }, example_sentence: { type: "STRING" }, example_translation: { type: "STRING" } }, required: ["word", "explanation", "example_sentence", "example_translation"] } } }),
            tone: (input) => ({ prompt: `Phân tích giọng điệu (ví dụ: Thân mật, Trang trọng, Giận dữ, Trung lập, Lịch sự) của câu tiếng Anh sau: "${input}". Cung cấp giải thích bằng tiếng Việt. Nếu có thể, đề xuất cách viết lại câu với 1-2 giọng điệu khác. Trả về đối tượng JSON với các khóa: "original_sentence", "tone", "explanation", "suggestions" (mảng các đối tượng, mỗi đối tượng có "new_tone" và "rewritten_sentence").`, schema: { type: "OBJECT", properties: { original_sentence: { type: "STRING" }, tone: { type: "STRING" }, explanation: { type: "STRING" }, suggestions: { type: "ARRAY", items: { type: "OBJECT", properties: { new_tone: { type: "STRING" }, rewritten_sentence: { type: "STRING" } } } } }, required: ["original_sentence", "tone", "explanation"] } }),
            idiom: (input) => ({ prompt: `Giải thích thành ngữ tiếng Anh '${input}'. Cung cấp bản dịch đen (nếu có, bằng tiếng Việt), ý nghĩa thực sự (bằng tiếng Việt), nguồn gốc hoặc câu chuyện đằng sau nó (bằng tiếng Việt), và 3 câu ví dụ (tiếng Anh kèm bản dịch tiếng Việt). Trả về JSON với các khóa: 'idiom', 'literal_translation', 'meaning', 'origin', 'examples' (mảng đối tượng có 'english' và 'vietnamese').`, schema: { type: "OBJECT", properties: { idiom: { type: "STRING" }, literal_translation: { type: "STRING" }, meaning: { type: "STRING" }, origin: { type: "STRING" }, examples: { type: "ARRAY", items: { type: "OBJECT", properties: { english: { type: "STRING" }, vietnamese: { type: "STRING" } }, required: ["english", "vietnamese"] } } }, required: ["idiom", "meaning", "origin", "examples"] } }),
            // NEW PROMPT FOR VSTEP EMAILS
            vstepEmails: (input) => ({ 
                prompt: `Bạn là một chuyên gia luyện thi VSTEP. Dựa vào yêu cầu viết thư sau đây: "${input}", hãy viết 3 email trả lời hoàn chỉnh. Các email phải tuân thủ quy tắc và cấu trúc của bài thi viết VSTEP (khoảng 120 từ hoặc hơn để có điểm cao hơn 1 chút, có mở bài, thân bài, kết bài, trả lời đủ các câu hỏi trong đề). Ba email phải ở 3 cấp độ khác nhau: B1, B2, C1. Quan trọng nhất: nội dung, ý tưởng, và cách phát triển ý của mỗi email phải khác nhau, không chỉ đơn thuần thay đổi từ vựng. Hãy thể hiện 3 cách tiếp cận vấn đề khác nhau. Trả về một đối tượng JSON với khóa 'emails' là một mảng các đối tượng, mỗi đối tượng có khóa 'level' (string: 'B1', 'B2', hoặc 'C1') và 'body' (string: toàn bộ nội dung email).`, 
                schema: { type: "OBJECT", properties: { emails: { type: "ARRAY", items: { type: "OBJECT", properties: { level: { type: "STRING" }, body: { type: "STRING" } }, required: ["level", "body"] } } }, required: ["emails"] } 
            }),
            translateVnToEn: (input) => ({ prompt: `Dịch câu tiếng Việt sau đây sang tiếng Anh: "${input}". Cung cấp 5-7 phương án dịch khác nhau, sắp xếp theo mức độ phổ biến từ cao đến thấp. Với mỗi phương án, hãy cung cấp: 1. Bản dịch tiếng Anh. 2. Trạng thái phổ biến BẰNG TIẾNG VIỆT (ví dụ: "Rất phổ biến", "Tự nhiên", "Hơi trang trọng", "Ít dùng"). 3. Một ghi chú ngắn về ngữ cảnh sử dụng BẰNG TIẾNG VIỆT. Trả về một mảng JSON các đối tượng có khóa: "english_translation", "popularity_status" (bằng tiếng Việt), "usage_note" (bằng tiếng Việt).`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { english_translation: { type: "STRING" }, popularity_status: { type: "STRING" }, usage_note: { type: "STRING" } }, required: ["english_translation", "popularity_status", "usage_note"] } } }),
            conversationCorrection: (originalSentence) => ({ prompt: `Phân tích câu tiếng Anh sau: "${originalSentence}". Nếu có lỗi ngữ pháp/cú pháp/chính tả, hãy sửa lại và giải thích chi tiết lỗi bằng tiếng Việt, cung cấp câu đã sửa, ghi chú chỉnh sửa, và dịch nghĩa. Nếu câu đúng, hãy xác nhận là đúng và dịch nghĩa. Trả về một đối tượng JSON với các khóa "originalSentence", "correctedSentence", "isCorrect", "correctionNotes", "alternativePhrases", và "vietnameseTranslation".`, schema: { type: "OBJECT", properties: { originalSentence: { type: "STRING" }, correctedSentence: { type: "STRING" }, isCorrect: { type: "BOOLEAN" }, correctionNotes: { type: "STRING" }, alternativePhrases: { type: "ARRAY", items: { type: "STRING" } }, vietnameseTranslation: { type: "STRING" } }, required: ["originalSentence", "correctedSentence", "isCorrect", "correctionNotes", "alternativePhrases", "vietnameseTranslation"] } }),
            getUnusedWords: (scenario) => ({ prompt: `Dựa trên kịch bản hội thoại "${scenario}", hãy gợi ý một danh sách khoảng 5-10 từ vựng tiếng Anh liên quan. Trả về một mảng JSON các chuỗi từ vựng.`, schema: { type: "ARRAY", items: { type: "STRING" } } }),
            conversationTurn: (conversationContext, latestMessage) => ({ prompt: `Tiếp tục cuộc hội thoại tiếng Anh này. Bạn là Alex. Bối cảnh: ${conversationContext}. Tin nhắn gần nhất: ${latestMessage}. Phản hồi ngắn gọn, tự nhiên. Trả về JSON có khóa "english" và "vietnamese".`, schema: { type: "OBJECT", properties: { english: { type: "STRING" }, vietnamese: { type: "STRING" } }, required: ["english", "vietnamese"] } }),
            translateText: (text) => ({ prompt: `Dịch sang tiếng Việt: "${text}". Trả về JSON có khóa "translation".`, schema: { type: "OBJECT", properties: { translation: { type: "STRING" } }, required: ["translation"] } })
        };
        
        // --- Function Triggers ---
        function generateExamples() { handleFeature('example', 'Tạo ví dụ', prompts.examples, renderers.examples); }
        function generateExercise() { handleFeature('exercise', 'Tạo Bài Tập Viết', prompts.exercise, renderers.exercise); }
        function generateListeningFillInTheBlank() { handleFeature('listeningFillInTheBlank', 'Bài tập Nghe & Điền từ', prompts.listeningFillInTheBlank, renderers.listeningFillInTheBlank); }
        function generateExplanation() { handleFeature('explanation', 'Giải thích Từ Vựng', prompts.explanation, renderers.explanation); }
        function correctSentence() { handleFeature('correction', 'Sửa Câu', prompts.correction, renderers.correction); }
        function generateDialogue() { handleFeature('dialogue', 'Tạo Đoạn Hội Thoại', prompts.dialogue, renderers.dialogue); }
        function summarizeText() { handleFeature('summary', 'Tóm Tắt Văn Bản', prompts.summary, renderers.summary); }
        function generateParagraphs() { handleFeature('paragraph', 'Viết Đoạn Văn', prompts.paragraphs, renderers.paragraphs, (input) => input.includes(',') || input.includes(' ')); }
        function checkPopularity() { handleFeature('popularity', 'Kiểm Tra Mức Độ Phổ Biến', prompts.popularity, renderers.popularity); }
        function translateSentence() { handleFeature('translation', 'Dịch câu Việt - Anh', prompts.translateVnToEn, renderers.translationResults); }
        function generateReadingAndQuestions() { handleFeature('reading', 'Bài Đọc & Câu Hỏi', prompts.reading, renderers.reading); }
        function generateListeningAndQuestions() { handleFeature('listening', 'Bài Nghe & Câu Hỏi', prompts.listening, renderers.listening); }
        function startSpeakingPractice() { handleFeature('speakingPractice', 'Luyện phản xạ nói', null, renderers.speakingPractice); }
        
        function startSpeakingPracticeManual() {
            const manualSpeakingModal = document.getElementById('manualSpeakingModal');
            manualSpeakingModal.style.display = 'flex'; 

            document.getElementById('startManualPracticeBtn').onclick = () => {
                const sentencesText = document.getElementById('manualSentencesInput').value.trim();
                const randomOrder = document.getElementById('randomOrderCheckbox').checked;

                if (!sentencesText) {
                    showMessage('Vui lòng nhập ít nhất một câu để luyện tập.', 'error');
                    return;
                }
                let sentences = sentencesText.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                if (sentences.length === 0) {
                    showMessage('Vui lòng nhập ít nhất một câu để luyện tập.', 'error');
                    return;
                }

                if (randomOrder) {
                    for (let i = sentences.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [sentences[i], sentences[j]] = [sentences[j], sentences[i]];
                    }
                }

                manualSpeakingModal.style.display = 'none';
                handleFeature('speakingPracticeManual', 'Luyện phản xạ thủ công', null, 
                    (input, content, headerText) => renderers.speakingPracticeManual(sentences, content, headerText),
                    (input) => true, // Validator
                    sentences // Pass sentences as featureInputValue
                );
            };

            document.getElementById('closeManualSpeakingModal').onclick = () => {
                manualSpeakingModal.style.display = 'none';
            };
            manualSpeakingModal.onclick = (event) => {
                if (event.target == manualSpeakingModal) {
                    manualSpeakingModal.style.display = 'none';
                }
            };
        }

        // NEW: Function to show the email prompt modal
        function showEmailPromptModal() {
            const emailModal = document.getElementById('emailPromptModal');
            emailModal.style.display = 'flex';

            document.getElementById('startEmailGenerationBtn').onclick = () => {
                const emailPrompt = document.getElementById('emailPromptInput').value.trim();
                if (!emailPrompt) {
                    showMessage('Vui lòng nhập đề bài hoặc chủ đề email.', 'error');
                    return;
                }
                emailModal.style.display = 'none';
                handleFeature(
                    'vstepEmails', 
                    'Soạn thảo Email theo cấp độ', 
                    prompts.vstepEmails, 
                    renderers.vstepEmails,
                    (input) => !!input, // Validator
                    emailPrompt // Pass the prompt from the modal as featureInputValue
                );
            };

            document.getElementById('closeEmailPromptModal').onclick = () => {
                emailModal.style.display = 'none';
            };
            emailModal.onclick = (event) => {
                if (event.target == emailModal) {
                    emailModal.style.display = 'none';
                }
            };
        }

        function startWritingPractice() { handleFeature('writingPractice', 'Luyện viết (AI)', null, renderers.writingPractice); }
        function compareVocabulary() { handleFeature('comparison', 'So Sánh Từ Vựng', prompts.comparison, renderers.comparison, (input) => input.split(',').length > 1); }
        function analyzeTone() { handleFeature('tone', 'Phân Tích Giọng Điệu', prompts.tone, renderers.tone); }
        function explainIdiom() { handleFeature('idiom', 'Giải thích Thành ngữ', prompts.idiom, renderers.idiom); }
        function startConversationSimulator() { handleFeature('conversationSimulator', 'Mô phỏng Hội thoại', null, renderers.conversationSimulator); }
        
        async function generateImage() {
            const promptText = vocabularyInput.value.trim();
            if (!promptText) {
                showMessage('Vui lòng nhập từ vựng hoặc mô tả để tạo ảnh.', 'error');
                return;
            }
            const { content, overlay } = createContentSection('imageGenerator', 'Đang tạo ảnh');
            try {
                const payload = { instances: { prompt: promptText }, parameters: { "sampleCount": 1} };
                const apiKey = "AIzaSyAFavlPk2DLCsZHdmpKrlwjwzQGO02ukio"; // If you want to use models other than imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Lỗi API hình ảnh: ${response.status}`);
                }
                const result = await response.json();
                
                if (result.predictions?.[0]?.bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    renderers.imageGenerator(imageUrl, content, 'Ảnh đã tạo', promptText);
                } else {
                    throw new Error('Không nhận được dữ liệu hình ảnh hợp lệ.');
                }
            } catch (error) {
                showMessage(`Có lỗi xảy ra khi tạo ảnh. Vui lòng thử lại.`, 'error');
                console.error(`Lỗi tạo ảnh:`, error);
                content.innerHTML = `<p class="text-red-500 font-semibold">Đã xảy ra lỗi: ${error.message}</p>`;
            } finally {
                if (overlay) overlay.style.display = 'none';
            }
        }

        // --- Interactive Answer Checking ---
        function checkFillInBlankAnswer(button, correctWord) {
            const item = button.closest('.exercise-item');
            const feedback = item.querySelector('.exercise-feedback');
            const options = item.querySelectorAll('.option-btn');
            
            options.forEach(btn => btn.disabled = true);

            if (button.dataset.value === correctWord) {
                button.classList.add('correct');
                feedback.innerHTML = 'Chính xác! 🎉';
                feedback.style.color = '#059669';
                feedback.style.backgroundColor = '#d1fae5';
            } else {
                button.classList.add('incorrect');
                feedback.innerHTML = `Sai rồi. Đáp án đúng là "<b>${correctWord}</b>"`;
                feedback.style.color = '#dc2626';
                feedback.style.backgroundColor = '#fee2e2';
                const correctButton = item.querySelector(`button[data-value="${correctWord.replace(/"/g, '&quot;')}"]`);
                if(correctButton) correctButton.classList.add('correct');
            }
        }

        function checkMultipleChoiceAnswer(button) {
            const item = button.closest('.question-item');
            const optionsContainer = button.parentElement;
            const feedbackEl = item.querySelector('.question-feedback');
            const correctAnswer = item.dataset.correctAnswer;
            const questionTranslation = item.dataset.questionTranslation;

            optionsContainer.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

            const isCorrect = button.textContent === correctAnswer;

            if (isCorrect) {
                button.classList.add('correct');
                feedbackEl.innerHTML = `Chính xác! 🎉 <br><span class="question-translation">(Dịch: ${questionTranslation})</span>`;
            } else {
                button.classList.add('incorrect');
                const correctBtn = Array.from(optionsContainer.querySelectorAll('button')).find(b => b.textContent === correctAnswer);
                if (correctBtn) {
                    correctBtn.classList.add('correct');
                }
                feedbackEl.innerHTML = `Sai rồi. Đáp án đúng là: "<b>${correctAnswer}</b>" <br><span class="question-translation">(Dịch: ${questionTranslation})</span>`;
            }
        }

        
        // --- Audio Player & Speech Recognition Logic ---
        function speakText(text) {
            if (!('speechSynthesis' in window)) {
                showMessage('Trình duyệt không hỗ trợ phát âm thanh.', 'error');
                return;
            }
            if (speechSynthesis.speaking && !isSpeakingFullDialogue) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
            if (voices.length > 0) {
                const preferredVoice = voices.find(v => v.name === 'Google US English' || v.name.includes('English (United States)'));
                utterance.voice = preferredVoice || voices[0];
                utterance.rate = 0.9;
            }
            
            utterance.onerror = (event) => console.error("Lỗi phát âm thanh:", event);

            speechSynthesis.speak(utterance);
        }

        function playQuestionAudio(button, text) {
            if (!('speechSynthesis' in window)) {
                showMessage('Trình duyệt của bạn không hỗ trợ phát âm thanh.', 'error');
                return;
            }
            if (speechSynthesis.speaking) speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
            if (voices.length > 0) {
                const preferredVoice = voices.find(v => v.name === 'Google US English' || v.name.includes('English (United States)'));
                utterance.voice = preferredVoice || voices[0];
            }
            
            const originalIconSVG = button.innerHTML;
            button.innerHTML = `<div class="spinning-loader"></div>`;
            button.disabled = true;

            utterance.onend = () => { button.innerHTML = originalIconSVG; button.disabled = false; };
            utterance.onerror = (event) => { button.innerHTML = originalIconSVG; button.disabled = false; console.error("Lỗi phát âm thanh:", event); };

            speechSynthesis.speak(utterance);
        }

        function setupAudioPlayer(script, container) {
            container.innerHTML = `
                <div class="audio-player">
                    <div class="audio-controls">
                        <button id="audioPlayBtn" class="audio-btn" title="Phát"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M10.804 8 5 4.633v6.734L10.804 8zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg></button>
                        <button id="audioPauseBtn" class="audio-btn" title="Tạm dừng" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M6 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5zm4 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg></button>
                        <button id="audioStopBtn" class="audio-btn" title="Dừng"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v4a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 0 1H6.5a.5.5 0 0 1 0-1H10.5zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg></button>
                    </div>
                    <div id="audioStatus" class="audio-status">Sẵn sàng</div>
                </div>
            `;
            
            const playBtn = document.getElementById('audioPlayBtn'), pauseBtn = document.getElementById('audioPauseBtn'), stopBtn = document.getElementById('audioStopBtn'), statusDiv = document.getElementById('audioStatus');
            if (!('speechSynthesis' in window)) { statusDiv.textContent = 'Trình duyệt không hỗ trợ'; playBtn.disabled = true; return; }

            let utterance = new SpeechSynthesisUtterance(script);
            let voices = [];
            const populateVoiceList = () => { voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en')); if (voices.length > 0) utterance.voice = voices.find(v => v.name === 'Google US English' || v.name.includes('English (United States)')) || voices[0]; };
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoiceList;

            utterance.onstart = () => { statusDiv.textContent = 'Đang phát...'; playBtn.style.display = 'none'; pauseBtn.style.display = 'flex'; };
            utterance.onpause = () => { statusDiv.textContent = 'Đã tạm dừng'; playBtn.style.display = 'flex'; pauseBtn.style.display = 'none'; };
            utterance.onresume = () => { statusDiv.textContent = 'Đang phát...'; playBtn.style.display = 'none'; pauseBtn.style.display = 'flex'; };
            utterance.onend = () => { statusDiv.textContent = 'Đã kết thúc'; playBtn.style.display = 'flex'; pauseBtn.style.display = 'none'; };
            utterance.onerror = (e) => { console.error(e); statusDiv.textContent = 'Lỗi phát âm'; playBtn.style.display = 'flex'; pauseBtn.style.display = 'none'; };

            playBtn.addEventListener('click', () => { if (speechSynthesis.paused) { speechSynthesis.resume(); } else { speechSynthesis.cancel(); setTimeout(() => speechSynthesis.speak(utterance), 100); } });
            pauseBtn.addEventListener('click', () => { if (speechSynthesis.speaking) speechSynthesis.pause(); });
            stopBtn.addEventListener('click', () => { if (speechSynthesis.speaking || speechSynthesis.paused) speechSynthesis.cancel(); });
        }

        async function handlePronunciationRecording(vietnameseSentence, suggestions) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showMessage('Trình duyệt của bạn không hỗ trợ nhận dạng giọng nói.', 'error');
                return;
            }

            let targetSuggestions = suggestions;
            const recordBtn = document.getElementById('record-pronunciation-btn');
            const scoreContainer = document.getElementById('pronunciation-score-container');

            // If a recording is already in progress, stop it and reset state
            if (isRecording) {
                if (recognition) recognition.stop();
                return; // Exit function, as the stop event will handle cleanup
            }

            // If no suggestions are available, fetch them
            if (targetSuggestions.length === 0) {
                 scoreContainer.innerHTML = '<p class="text-center font-semibold">Đang lấy câu gợi ý...</p>';
                 scoreContainer.classList.remove('hidden');
                 try {
                    const { prompt, schema } = prompts.speakingPracticeSingle(vietnameseSentence);
                    const suggestionData = await callGemini(prompt, schema);
                    targetSuggestions = suggestionData.suggestions;

                    if (!targetSuggestions || targetSuggestions.length === 0) {
                        throw new Error("AI không trả về gợi ý.");
                    }
                    scoreContainer.classList.add('hidden'); // Hide "Đang lấy câu gợi ý..."
                    scoreContainer.innerHTML = ''; // Clear content
                 } catch (error) {
                    console.error('Lỗi khi lấy gợi ý tự động:', error);
                    showMessage('Không thể lấy câu gợi ý để chấm điểm. Vui lòng thử lại.', 'error');
                    scoreContainer.classList.add('hidden');
                    scoreContainer.innerHTML = '';
                    return;
                 }
            }

            const targetSentence = targetSuggestions[0].translation; // Use the first suggestion as the target

            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const recordBtnSpan = recordBtn.querySelector('span');
            const originalBtnText = recordBtnSpan.textContent;

            recognition.onstart = () => {
                isRecording = true;
                recordBtn.classList.add('recording');
                recordBtnSpan.textContent = 'Đang ghi âm... (Nhấn để dừng)';
                // recordBtn.disabled = true; // No longer disable, allow stopping
                scoreContainer.classList.add('hidden');
            };

            recognition.onresult = async (event) => {
                const spokenText = event.results[0][0].transcript;
                scoreContainer.innerHTML = '<p class="text-center font-semibold">Đang chấm điểm...</p>';
                scoreContainer.classList.remove('hidden');

                try {
                    const {prompt, schema} = prompts.pronunciationScore(targetSentence, spokenText);
                    const result = await callGemini(prompt, schema);
                    
                    // Highlight differences
                    const highlightedSpokenText = highlightDifferences(targetSentence, spokenText);

                    scoreContainer.innerHTML = `
                        <div class="pronunciation-score-card">
                            <div class="score-circle">${result.score}%</div>
                            <h4 class="card-title-alt">Kết quả của bạn</h4>
                            <p class="text-lg italic">"${highlightedSpokenText}"</p>
                            <h4 class="card-title-alt mt-4">Câu trả lời gợi ý</h4>
                            <p class="text-lg font-medium text-green-600">"${targetSentence}"</p>
                            <h4 class="card-title-alt mt-4">Nhận xét của AI</h4>
                            <p>${result.feedback}</p>
                        </div>
                    `;

                } catch (error) {
                    console.error('Lỗi chấm điểm phát âm:', error);
                    scoreContainer.innerHTML = `<p class="text-red-500">Lỗi: ${error.message}</p>`;
                }
            };

            recognition.onerror = (event) => {
                console.error('Lỗi nhận dạng giọng nói:', event.error);
                showMessage(`Lỗi ghi âm: ${event.error}`, 'error');
            };

            recognition.onend = () => {
                isRecording = false;
                recordBtn.classList.remove('recording');
                recordBtnSpan.textContent = originalBtnText;
                // recordBtn.disabled = false; // Re-enable if it was disabled
            };

            recognition.start();
        }

        function playFullDialogue(lines) {
            if (!('speechSynthesis' in window)) {
                showMessage('Trình duyệt không hỗ trợ phát âm thanh.', 'error');
                return;
            }
            if (speechSynthesis.speaking || speechSynthesis.pending) {
                speechSynthesis.cancel(); 
            }

            isSpeakingFullDialogue = true;
            currentUtteranceQueue = [...lines]; 
            // Also stop recording if active
            if (isRecording) {
                if (recognition) recognition.stop();
            }


            const speakNextLine = () => {
                if (currentUtteranceQueue.length > 0 && isSpeakingFullDialogue) {
                    const line = currentUtteranceQueue.shift();
                    const utterance = new SpeechSynthesisUtterance(line);
                    const voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
                    if (voices.length > 0) {
                        const preferredVoice = voices.find(v => v.name === 'Google US English' || v.name.includes('English (United States)'));
                        utterance.voice = preferredVoice || voices[0];
                        utterance.rate = 0.9;
                    }
                    
                    utterance.onend = () => {
                        speakNextLine(); 
                    };
                    utterance.onerror = (event) => {
                        console.error("Lỗi phát âm dòng hội thoại:", event);
                        speakNextLine(); 
                    };
                    speechSynthesis.speak(utterance);
                } else {
                    isSpeakingFullDialogue = false; 
                }
            };
            speakNextLine(); 
        }

        // --- Conversation Simulator Logic ---
        async function initializeUnusedWords(scenario) {
            try {
                const { prompt, schema } = prompts.getUnusedWords(scenario);
                const words = await callGemini(prompt, schema);
                unusedWords = words.map(word => word.toLowerCase());
                updateUnusedWordsDisplay();
            } catch (error) {
                console.error("Error initializing unused words:", error);
                unusedWords = ["excellent", "challenge", "opportunity", "fluent", "practice"];
                updateUnusedWordsDisplay();
            }
        }

        function updateUnusedWordsDisplay() {
            const unusedWordsListEl = document.getElementById('unusedWordsList');
            if (unusedWordsListEl) {
                if (unusedWords.length > 0) {
                    unusedWordsListEl.textContent = unusedWords.join(', ');
                } else {
                    unusedWordsListEl.textContent = 'Tuyệt vời! Bạn đã sử dụng hết các từ gợi ý.';
                }
            }
        }
        
        async function getNextAiResponse() {
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            try {
                const context = conversationHistory.map(turn => `${turn.role}: ${turn.parts[0].text}`).join('\n');
                const lastUserMessage = conversationHistory.length > 1 ? conversationHistory[conversationHistory.length - 1].parts[0].text : "(bắt đầu cuộc hội thoại)";
                const { prompt, schema } = prompts.conversationTurn(context, lastUserMessage);
                const aiResponse = await callGemini(prompt, schema);
                
                const modelResponse = { role: 'model', parts: [{ text: aiResponse.english }] };
                conversationHistory.push(modelResponse);
                addMessageToUI(aiResponse.english, aiResponse.vietnamese, 'ai');
            } catch (error) {
                console.error("Lỗi hội thoại:", error);
                addMessageToUI('Xin lỗi, tôi gặp sự cố.', 'Sorry, I encountered an issue.', 'ai');
            } finally {
                if (chatInput) chatInput.disabled = false;
                if (chatSendButton) chatSendButton.disabled = false;
            }
        }

        function addMessageToUI(englishText, vietnameseTranslation, sender) {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) return;
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `
                <span>${englishText}</span>
                <p class="translation">(Dịch: ${vietnameseTranslation})</p>
            `;
            messageArea.appendChild(messageDiv);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        async function continueConversation(scenario) {
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            if (!chatInput) return;
            
            const userMessageEnglish = chatInput.value.trim();
            if (!userMessageEnglish) return;

            chatInput.disabled = true;
            if(chatSendButton) chatSendButton.disabled = true;

            let userMessageVietnamese = '';
            try {
                const { prompt, schema } = prompts.translateText(userMessageEnglish);
                const translationResult = await callGemini(prompt, schema);
                userMessageVietnamese = translationResult.translation;
            } catch (error) {
                console.error("Lỗi dịch:", error);
                userMessageVietnamese = "Không thể dịch.";
            }

            const userTurn = { role: 'user', parts: [{ text: userMessageEnglish }] };
            conversationHistory.push(userTurn);
            addMessageToUI(userMessageEnglish, userMessageVietnamese, 'user');
            chatInput.value = '';

            const userWords = userMessageEnglish.toLowerCase().split(/\s+|[.,!?;:]+/).filter(Boolean);
            unusedWords = unusedWords.filter(word => !userWords.includes(word));
            updateUnusedWordsDisplay();

            try {
                const { prompt, schema } = prompts.conversationCorrection(userMessageEnglish);
                const correctionResult = await callGemini(prompt, schema);
                if (!correctionResult.isCorrect) {
                    showCorrectionModal(correctionResult);
                }
            } catch (error) {
                console.error("Lỗi kiểm tra ngữ pháp:", error);
            }
            
            await getNextAiResponse();
        }

        function showCorrectionModal(data) {
            modalCorrectionContent.innerHTML = `
                <div class="table-container">
                <table class="correction-table w-full">
                    <tr> <th class="w-1/3">Mục</th> <th>Nội dung</th> </tr>
                    <tr> <td>📥 Câu gốc</td> <td>${data.originalSentence}</td> </tr>
                    <tr> <td>✅ Câu đã sửa</td> <td>${data.correctedSentence}</td> </tr>
                    <tr> <td>🛠️ Ghi chú</td> <td>${data.correctionNotes}</td> </tr>
                    <tr> <td>💬 Cách nói khác</td> <td>${data.alternativePhrases.join(' / ')}</td> </tr>
                    <tr> <td>🇻🇳 Dịch nghĩa</td> <td>${data.vietnameseTranslation}</td> </tr>
                </table>
                </div>
            `;
            correctionModal.style.display = 'flex';
        }

        // --- Quick Search & Spell Check ---
        function searchWithCorrection(correctedWord) {
            vocabularyInput.value = correctedWord;
            quickSearch();
        }

        async function quickSearch(options = {}) {
            const { bypassSpellCheck = false, wordToSearch = null } = options;
            const input = wordToSearch || vocabularyInput.value.trim();
            if (!input) {
                showMessage('Vui lòng nhập từ hoặc cụm từ để tra cứu.', 'error');
                return;
            }
            
            hideAllSections(); 
            
            quickSearchResults.innerHTML = `<div class="info-card p-4 flex items-center justify-center"> <div class="loading-spinner" style="width: 24px; height: 24px; border-width: 3px;"></div> <span class="ml-3 text-gray-600 dark:text-gray-300">Đang tra cứu...</span> </div>`;
            
            if (!bypassSpellCheck && !input.includes(' ')) {
                try {
                    const { prompt, schema } = prompts.spellCheck(input);
                    const spellResult = await callGemini(prompt, schema);

                    if (!spellResult.is_correct && spellResult.corrected_word.toLowerCase() !== input.toLowerCase()) {
                        renderers.spellCheckSuggestion(input, spellResult.corrected_word, quickSearchResults);
                        return; 
                    }
                } catch (error) {
                    console.error("Spell check failed:", error);
                }
            }

            speakText(input);

            try {
                const { prompt, schema } = prompts.quickLookup(input);
                const data = await callGemini(prompt, schema);
                renderers.quickLookup(data, quickSearchResults);
            } catch (error) {
                showMessage('Không thể tra cứu. Vui lòng thử lại.', 'error');
                console.error('Lỗi tra cứu nhanh:', error);
                quickSearchResults.innerHTML = `<div class="info-card p-4 text-center text-red-600 dark:text-red-400">Không tìm thấy kết quả cho "${input}".</div>`;
            }
        }

        function startWritingPracticeManual() {
            const modal = document.getElementById('writingPracticeManualModal');
            modal.style.display = 'flex';

            document.getElementById('startManualWritingBtn').onclick = () => {
                const itemsText = document.getElementById('manualWritingInput').value.trim();
                const isRandomOrder = document.getElementById('randomWritingCheckbox').checked;
                const practiceDirection = document.querySelector('input[name="practiceMode"]:checked').value;

                if (!itemsText) {
                    showMessage('Vui lòng nhập ít nhất một cặp từ/câu để luyện tập.', 'error');
                    return;
                }

                const lines = itemsText.split('\n').filter(line => line.includes('='));
                if (lines.length === 0) {
                    showMessage('Định dạng không hợp lệ. Vui lòng dùng dấu "=" để ngăn cách Tiếng Việt và Tiếng Anh.', 'error');
                    return;
                }

                let practicePairs = lines.map(line => {
                    const parts = line.split('=').map(part => part.trim());
                    // Heuristic to guess which is which, assuming Vietnamese might contain non-ASCII
                    const hasVietnamese = /[àáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]/i.test(parts[0]);
                    if (hasVietnamese) {
                        return { vi: parts[0], en: parts[1] };
                    }
                    // If both or neither seem to be vietnamese, we assume vi = en format
                    return { vi: parts[0], en: parts[1] };
                }).filter(p => p.vi && p.en);
                
                if (practicePairs.length === 0) {
                    showMessage('Không tìm thấy cặp từ/câu hợp lệ nào. Hãy kiểm tra lại định dạng.', 'error');
                    return;
                }

                if (isRandomOrder) {
                    for (let i = practicePairs.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [practicePairs[i], practicePairs[j]] = [practicePairs[j], practicePairs[i]];
                    }
                }

                modal.style.display = 'none';
                handleFeature('writingPracticeManual', 'Luyện dịch thủ công', null,
                    (input, content, headerText) => renderers.writingPracticeManual({ pairs: practicePairs, direction: practiceDirection }, content, headerText),
                    (input) => true,
                    { pairs: practicePairs, direction: practiceDirection }
                );
            };

            document.getElementById('closeWritingPracticeManualModal').onclick = () => {
                modal.style.display = 'none';
            };
            modal.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };
        }

        // --- Event Listeners ---
        function attachEventListeners() {
            document.getElementById('btnClearInput').addEventListener('click', clearInput);
            document.getElementById('btnPasteClipboard').addEventListener('click', pasteFromClipboard);
            document.getElementById('btnQuickSearch').addEventListener('click', () => quickSearch());

            document.getElementById('btnGenerateExercise').addEventListener('click', generateExercise);
            document.getElementById('btnGenerateListeningFillInTheBlank').addEventListener('click', generateListeningFillInTheBlank);
            document.getElementById('btnGenerateExplanation').addEventListener('click', generateExplanation);
            document.getElementById('btnCorrectSentence').addEventListener('click', correctSentence);
            document.getElementById('btnGenerateReadingAndQuestions').addEventListener('click', generateReadingAndQuestions);
            document.getElementById('btnGenerateListeningAndQuestions').addEventListener('click', generateListeningAndQuestions);
            document.getElementById('btnGenerateExamples').addEventListener('click', generateExamples);
            document.getElementById('btnGenerateDialogue').addEventListener('click', generateDialogue);
            document.getElementById('btnGenerateParagraphs').addEventListener('click', generateParagraphs);
            document.getElementById('btnSummarizeText').addEventListener('click', summarizeText);
            document.getElementById('btnStartWritingPractice').addEventListener('click', startWritingPractice);
            document.getElementById('btnCompareVocabulary').addEventListener('click', compareVocabulary);
            document.getElementById('btnAnalyzeTone').addEventListener('click', analyzeTone);
            document.getElementById('btnExplainIdiom').addEventListener('click', explainIdiom);
            document.getElementById('btnCheckPopularity').addEventListener('click', checkPopularity);
            document.getElementById('btnTranslateSentence').addEventListener('click', translateSentence);
            document.getElementById('btnStartConversationSimulator').addEventListener('click', startConversationSimulator);
            // UPDATED: This button now opens the new modal
            document.getElementById('btnDraftEmail').addEventListener('click', showEmailPromptModal);
            document.getElementById('btnGenerateImage').addEventListener('click', generateImage);
            document.getElementById('btnStartSpeakingPractice').addEventListener('click', startSpeakingPractice);
            document.getElementById('btnStartSpeakingPracticeManual').addEventListener('click', startSpeakingPracticeManual);

            document.getElementById('btnGoogleTranslate').addEventListener('click', () => openLink('googleTranslate'));
            document.getElementById('btnOxfordDictionary').addEventListener('click', () => openLink('oxfordDictionary'));
            document.getElementById('btnYouglish').addEventListener('click', () => openLink('youglish'));
            document.getElementById('btnGoogleImages').addEventListener('click', () => openLink('googleImages'));
            document.getElementById('btnStartWritingPracticeManual').addEventListener('click', startWritingPracticeManual);

            closeCorrectionModalBtn.addEventListener('click', () => { correctionModal.style.display = 'none'; });
            window.addEventListener('click', (event) => { if (event.target == correctionModal) { correctionModal.style.display = 'none'; } });
        }
    </script>
</body>
</html>


